<div class="row mt-2">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="card-title">
          <button class="pull-right btn btn-success btn-sm" style="float: right;" (click)="openModal()">
            <i class="fa fa-plus"></i> Agregar
          </button>
          <h5 class="text-primary">Materiales</h5>
          <div class="form-row ml-0 mt-2">
            <div class="form-group">
              <label for="">Filtro nombre</label>
              <input type="text" class="form-control form-control-sm" [(ngModel)]="filtro.name"
                (change)="getMaterials()" name="name" autocomplete="off">
            </div>
          </div>
          <hr class="bg-primary">
        </div>
        <table class="table table-borderless table-striped mt-4" *ngIf="!loading && materials.length > 0; else notData">
          <thead class="bg-light">
            <tr>
              <th>Nombre</th>
              <th>Unidad</th>
              <th>Tipo</th>
              <th>Valor KG</th>
              <th>F. Creación</th>
              <th class="text-center">Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of materials">
              <td> {{ item.name | uppercase }} </td>
              <td> {{ item.unit | titlecase }} </td>
              <td> {{ item.type }} </td>
              <td> {{ item.kg_value }} </td>
              <td> {{ item.created_at | date: 'dd-MM-YYYY' }} </td>
              <td>
                <div class="text-center">
                  <div ngbDropdown class="dropdown-primary">
                    <button ngbDropdownToggle class="btn btn-primary btn-sm waves-effect waves-light " type="button">
                      <i class="mdi mdi-chevron-down"></i>
                    </button>
                    <div ngbDropdownMenu>
                      <a class="dropdown-item waves-light text-dark waves-effect caja-botones"
                        (click)="getMaterial(item); modalVer.show()">
                        <i class="far fa-eye"></i> Ver
                      </a>
                      <a class="dropdown-item waves-light text-info waves-effect caja-botones"
                        (click)="getMaterial(item); modal.show()">
                        <i class="far fa-edit"></i> Editar
                      </a>
                    </div>
                  </div>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
        <ngb-pagination class="d-flex justify-content-center pagination-rounded pagination-sm"
          [collectionSize]="pagination.collectionSize" [pageSize]="pagination.pageSize" [(page)]="pagination.page"
          (pageChange)="getMaterials($event)" aria-label="Default pagination" maxSize="5" rotate="true" ellipses="false"
          boundaryLinks="true" rotate="true" ellipses="false" boundaryLinks="true">
        </ngb-pagination>
      </div>
    </div>
  </div>
</div>



<app-modal-basic #modal [dialogClass]="'modal-lg'">
  <div class="app-modal-header">
    <h5 class="modal-title">{{ title }}</h5>
    <button type="button" class="close basic-close" (click)="closeModal()">
      <span aria-hidden="true">
        <i class="fas fa-times"></i>
      </span>
    </button>
  </div>
  <div class="app-modal-body">
    <form [formGroup]="form">
      <div class="row">
        <input type="hidden" class="form-control form-control-sm" formControlName="product_id">

        <div class="col-12">
          <div class="form-row">
            <div class="form-group col-md-6">
              <label for="">Nombre</label>
              <input type="text" class="form-control form-control-sm" formControlName="name">
            </div>
            <div class="form-group col-md-6">
              <label for="">Unidad</label>
              <select class="form-control form-control-sm" name="color" formControlName="unit">
                <option value="milimetros">Milimetros</option>
                <option value="unidad">Unidad</option>
              </select>
            </div>

            <div class="form-group col-md-6">
              <label for="tipo">Tipo</label>
              <select class="form-control form-control-sm" name="color" formControlName="type">
                <option value="Interno">Interno</option>
                <option value="Comercial">Comercial</option>
              </select>
            </div>
            <div class="form-group col-md-6">
              <label for="tipo">Valor KG</label>
              <input type="number" class="form-control form-control-sm" formControlName="kg_value">
            </div>

            <div class="form-group col-md-6">
              <label for="">Código Barras</label>
              <input type="text" class="form-control form-control-sm" formControlName="Codigo_Barras">
            </div>
            <div class="form-group col-md-6">
              <label for="tipo">Tipo Catalogo</label>
              <select class="form-control form-control-sm" name="color" formControlName="Tipo_Catalogo">
                <option value="Material">Material</option>
                <!--<option value="Epp">Epp</option>-->
              </select>
            </div>

            <div class="col-md-6">
              <div class="form-group">
                <label>Categoria</label>
                <ng-select formControlName="Id_Categoria" [items]="Categorias" bindLabel="text"
                  (change)="getSubCategories($event.value)" bindValue="value" loadingText="loading" ngDefaultControl>
                </ng-select>
              </div>
            </div>

            <div class="col-md-6">
              <div class="form-group">
                <label>Subcategoría</label>
                <ng-select formControlName="Id_Subcategoria" [items]="SubCategorias" bindLabel="text"
                  (change)="getDinamicField($event.value)" bindValue="value" loadingText="loading" ngDefaultControl>
                </ng-select>
              </div>
            </div>

            <ng-container formArrayName="dynamic">
              <ng-container *ngFor="let item of fieldDinamic.controls; let i = index">
                <div class="col-md-3" [formGroupName]="i">
                  <label for="">{{
                    item["controls"]["label"]["value"] | titlecase
                    }}</label>
                  <input class="form-control form-control-sm" [type]="item['controls']['type']['value']"
                    formControlName="valor" />
                </div>
              </ng-container>
            </ng-container>


            <div class="col-12 mt-4">
              <label for="" style="font-size: 18px;">Espesores</label>
            </div>
            <ng-container formArrayName="thicknesses">
              <div class="form-group col-1" *ngFor="let item of thicknessList.controls; let i = index">
                <ng-container [formGroupName]="i">
                  <label for=""> {{ item.controls.thickness.value }} </label>
                  <input type="number" class="form-control form-control-sm" formControlName="value">
                </ng-container>
              </div>
            </ng-container>
            <ng-container>
              <perfect-scrollbar style="height: 250px;">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>
                        <label for="">Propiedad</label>
                      </th>
                      <th>
                        <label for="tipo">Caracteristica</label>
                      </th>
                      <th>
                        <label>Valor</label>
                      </th>
                    </tr>
                  </thead>
                  <tbody formArrayName="fields">
                    <ng-container *ngIf="fieldList.controls.length; else sinDatos">
                      <ng-container *ngFor="let item of fieldList.controls; let i = index">
                        <tr [formGroupName]="i">
                          <td>
                            <input type="text" class="form-control form-control-sm" formControlName="property">
                          </td>
                          <td>
                            <select class="form-control form-control-sm" name="color" formControlName="type">
                              <option value="number">Number</option>
                              <option value="text">Text</option>
                              <option value="date">Date</option>
                              <option value="text">Color</option>
                            </select>
                          </td>
                          <td>
                            <input [type]="item['controls']['type']['value']" class="form-control form-control-sm"
                              formControlName="value">
                          </td>
                          <td>
                            <button style="float: right;" class="btn btn-danger btn-sm" placement="bottom" type="button"
                              ngbTooltip="Borrar" (click)="deleteField(i)">
                              <i class="fas fa-trash-alt"></i>
                            </button>
                          </td>
                        </tr>
                      </ng-container>
                    </ng-container>
                    <tr>
                      <td colspan="4">
                        <div class="btn-group" style="float: right">
                          <button class="btn btn-info btn-sm" placement="bottom" type="button" ngbTooltip="Agregar"
                            (click)="newField()">
                            <i class="fas fa-plus"></i>
                          </button>
                        </div>
                      </td>
                    </tr>
                  </tbody>
                </table>
              </perfect-scrollbar>
            </ng-container>
          </div>
        </div>
      </div>
    </form>
  </div>
  <div class="app-modal-footer">
    <div class="form-group text-right">
      <button (click)="closeModal()" type="button"
        class="btn btn-danger raised mr-2 btn-sm">Cerrar</button>
      <button type="submit" class="btn btn-primary btn-sm raised" [disabled]="!form.valid"
        (click)="save()">Guardar</button>
    </div>
  </div>
</app-modal-basic>



<app-modal-basic #modalVer [dialogClass]="'modal-lg'">
  <div class="app-modal-header">
    <h5 class="modal-title">Ver Materia Material</h5>
    <button type="button" class="close basic-close" (click)="modalVer.hide(); closeModalVer()">
      <span aria-hidden="true">
        <i class="fas fa-times"></i>
      </span>
    </button>
  </div>
  <div class="app-modal-body">
    <div class="row">
      <div class="col-6">
        <strong class="text-title"> PROPIEDADES ({{ material.name | titlecase }}) </strong>
        <perfect-scrollbar style="height: 300px;">
          <table class="table table-sm table-striped">
            <thead>
              <tr class="bg-light stay">
                <th>Propiedad</th>
                <th>Tipo</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of material.material_field">
                <td> {{ item.property }} </td>
                <td> {{ item.type }} </td>
                <td> {{ item.value }} </td>
              </tr>
            </tbody>
          </table>
        </perfect-scrollbar>
      </div>
      <div class="col-6">
        <strong class="text-title"> ESPESORES ({{ material.name | titlecase }}) </strong>
        <perfect-scrollbar style="height: 400px;">
          <table class="table table-sm table-striped">
            <thead>
              <tr class="bg-light stay">
                <th>Espesor</th>
                <th>Valor</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of material.material_thickness">
                <td> {{ item.thickness.thickness }} </td>
                <td> {{ item.value }} </td>
              </tr>
            </tbody>
          </table>
        </perfect-scrollbar>
      </div>
    </div>
  </div>
  <div class="app-modal-footer">
    <div class="form-group text-right">
      <button (click)="modalVer.hide(); closeModalVer()" type="button"
        class="btn btn-danger raised mr-2 btn-sm">Cerrar</button>
    </div>
  </div>
</app-modal-basic>


<ng-template #notData>
  <app-not-data [loading]="loading"></app-not-data>
</ng-template>
<ng-template #si>
  <p>Si</p>
</ng-template>
<ng-template #no>
  <p>No</p>
</ng-template>
<ng-template #sinDatos>
  <tr class="bg-light">
    <td colspan="100%" class="text-center">
      <p class="text-dark">Sin datos agregados</p>
    </td>
  </tr>
</ng-template>
