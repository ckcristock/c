<!-- <form [formGroup]=" -->
<form [formGroup]="formCompra">
  <div class="card">
    <div class="card-body">
      <div class="row card-title d-flex justify-content-between">
        <app-cabecera
          class="col"
          [datosCabecera]="datosCabecera"
        ></app-cabecera>
      </div>
      <hr class="line" />
      <div class="row">
        <div class="col-md-6">
          <div class="row">
            <mat-form-field class="col" appearance="outline">
              <mat-label>Tipo de compra:</mat-label>
              <mat-select name="Tipo" formControlName="Tipo" matInput required>
                <mat-option value="Recurrente" selected>Recurrente</mat-option>
                <mat-option value="Ocasional">Ocasional</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field class="col" appearance="outline">
              <mat-label>Fecha de entrega probable: </mat-label>
              <input
                type="date"
                formControlName="Fecha_Entrega_Probable"
                placeholder=""
                matInput
                required
              />
            </mat-form-field>
          </div>
          <div class="row">
            <mat-form-field class="col" appearance="outline">
              <mat-label>Tipo de bodega</mat-label>
              <mat-select
                name="TipoBodega"
                [(value)]="TipoBodega"
                matInput
                required
              >
                <mat-option value="Bodega" selected>Bodega</mat-option>
                <mat-option value="Punto">Punto de dispensación</mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field
              class="col"
              appearance="outline"
              *ngIf="TipoBodega == 'Bodega'"
            >
              <mat-label>Bodega</mat-label>
              <mat-select
                formControlName="Id_Bodega_Nuevo"
                matInput
                required
                placeholder="Seleccione una Bodega"
              >
                <!-- <mat-option [ngValue]="undefined"
                  >Seleccione una Bodega</mat-option
                > -->
                <mat-option
                  *ngFor="let Bodega of Bodegas; let i = index"
                  [value]="Bodega.Id_Bodega_Nuevo"
                >
                  {{ Bodega.Nombre }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <mat-form-field
              class="col"
              appearance="outline"
              *ngIf="TipoBodega == 'Punto'"
            >
              <mat-label>Punto de dispensación</mat-label>
              <mat-select
                formControlName="Id_Punto_Dispensacion"
                matInput
                required
                placeholder="Seleccione un Punto de dispensación"
              >
                <!-- <mat-option [ngValue]="undefined"
                  >Seleccione un Punto</mat-option
                > -->
                <mat-option
                  *ngFor="let item of puntos; let i = index"
                  [value]="item.Id_Punto_Dispensacion"
                >
                  {{ item.Nombre }}
                </mat-option>
              </mat-select>
            </mat-form-field>
            <input
              type="text"
              [(value)]="user"
              formControlName="Identificacion_Funcionario"
              readonly
              hidden
            />
          </div>
          <div class="row">
            <div class="col mat-form-field-wrapper">
              <ng-select
                [items]="Proveedores"
                formControlName="Id_Proveedor"
                bindLabel="text"
                appearance="outline"
                [appendTo]="'body'"
                placeholder="Proveedor"
                bindValue="value"
                loadingText="Cargando"
                matInput
                required
              >
              </ng-select>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <mat-form-field
            class="col-md-12 px-0 mat-form-field-no-padding textarea"
            appearance="outline"
          >
            <mat-label>Observaciones</mat-label>
            <textarea
              formControlName="Observaciones"
              placeholder="Digite detalles importantes de la orden de compra"
              type="text"
              rows="9"
              matInput
            ></textarea>
          </mat-form-field>
        </div>
      </div>
      <div class="row">
        <small class="font-weight-bold col">
          *Nota: Para hacer más efectiva la busqueda, por favor digite el nombre
          completo del producto.
        </small>
      </div>
      <div class="row">
        <div class="col-10">
          <div class="row">
            <div class="col mat-form-field-wrapper">
              <ng-select
                name="Categoria"
                [items]="Categorias"
                bindLabel="Nombre"
                bindValue="Id_Categoria_Nueva"
                [(ngModel)]="selectedCategory.categoria"
                [ngModelOptions]="{ standalone: true }"
                (change)="getSubCategories($event)"
                [disabled]="listaProductosPorAgregar.length > 0"
                appearance="outline"
                autocomplete="off"
                [appendTo]="'body'"
                placeholder="Categoria"
                matInput
              >
              </ng-select>
            </div>
            <div class="col mat-form-field-wrapper">
              <ng-select
                name="Subcategoria"
                [items]="subcategorias"
                bindLabel="Nombre"
                bindValue="Id_Subcategoria"
                [(ngModel)]="selectedCategory.subcategoria"
                [ngModelOptions]="{ standalone: true }"
                (change)="filtros()"
                [disabled]="listaProductosPorAgregar.length > 0"
                appearance="outline"
                autocomplete="off"
                [appendTo]="'body'"
                placeholder="Subcategoria"
                matInput
              >
              </ng-select>
            </div>
            <div class="col mat-form-field-wrapper">
              <ng-select
                name="Producto"
                [(ngModel)]="productoFiltro"
                [ngModelOptions]="{ standalone: true }"
                [items]="Productos"
                bindLabel="producto"
                (change)="AgregarProducto($event)"
                (click)="productoFiltro = {}"
                [editableSearchTerm]="true"
                appearance="outline"
                autocomplete="off"
                [appendTo]="'body'"
                placeholder="Producto"
                matInput
              >
              </ng-select>
            </div>
          </div>
        </div>
        <div
          class="col mat-form-field-wrapper d-flex align-items-center justify-content-center"
        >
          <button
            class="btn btn-danger btn-sm"
            (click)="
              listaProductosPorAgregar = [];
              products.clear();
              filtros();
              ActualizaValores()
            "
          >
            <i class="fa fa-trash"></i> Vaciar lista
          </button>
        </div>
      </div>
      <div class="row" *ngIf="listaProductosPorAgregar.length > 0">
        <small class="font-weight-bold col text-danger text-center"
          >No puede cambiar de categoría mientras que la lista de productos no
          esté vacía.</small
        >
      </div>
      <div class="rounded-top table-responsive">
        <table class="table table-bordered table-striped table-sm">
          <thead class="bg-light">
            <tr class="text-center text-uppercase">
              <th class="col-4">Producto</th>
              <th></th>
              <th class="col-1">Presentación</th>
              <th class="col-1" *ngIf="Rotativo">Rotativo</th>
              <th class="col-1">Cantidad</th>
              <th class="col-2">Costo</th>
              <th class="col-1">IVA</th>
              <th class="col-2">Subtotal</th>
              <th></th>
            </tr>
          </thead>
          <tbody formArrayName="Productos">
            <tr
              *ngFor="let item of listaProductosPorAgregar; let i = index"
              id="fila{{ i }}"
              [formGroupName]="i"
            >
              <td class="align-middle">
                <!-- <input
                  type="hidden"
                  name="productoModel{{ i }}"
                  [ngModel]="item.producto"
                />
                <input
                  *ngIf="item.Id_Producto == ''"
                  type="text"
                  name="producto{{ i }}"
                  id="Producto{{ i }}"
                  class="form-control form-control-sm"
                  autocomplete="off"
                  [value]="item.producto"
                  [readonly]="item.producto != ''"
                /> -->
                <span>{{ item.producto }}</span>
              </td>
              <td class="text-center align-middle">
                <!-- <button
                  *ngIf="item.producto == ''"
                  class="btn btn-primary btn-sm"
                  (click)="searchProduct(i, item.editar); openConfirm(add)"
                  title="Buscar Producto"
                >
                  <i class="fa fa-search"></i>
                </button> -->
                <span
                  *ngIf="item.producto != ''"
                  class="mytooltip tooltip-effect-2"
                >
                  <span class="tooltip-item2">Embalaje</span>
                  <span class="tooltip-content4 clearfix">
                    <span class="tooltip-text2">{{ item.Embalaje }}</span>
                  </span>
                </span>
                <!-- <button
                  *ngIf="item.delete"
                  class="btn btn-danger btn-xs btn-search"
                  (click)="deleteProduct(i)"
                  title="Eliminar producto"
                  style="display: inline-block"
                >
                  &nbsp;<i class="fa fa-trash"></i>
                </button> -->
              </td>
              <td class="text-center align-middle">
                <input
                  type="hidden"
                  name="PresentacionModel{{ i }}"
                  [value]="item.Presentacion"
                />
                <span id="Presentacion{{ i }}" name="Presentacion{{ i }}">
                  {{ item.Presentacion }}
                </span>
              </td>
              <td *ngIf="Rotativo">
                <input
                  readonly
                  id="Rotativo{{ i }}"
                  name="Rotativo{{ i }}"
                  [value]="item.Rotativo"
                  type="number"
                  min="1"
                  class="form-control form-control-sm text-right f-9"
                />
              </td>
              <td>
                <!--<input id="Cantidad{{i}}" name="Cantidad{{i}}" [ngModel]="item.Cantidad" type="number" min="1" class="form-control form-control-sm text-right f-9"
                        (change)="CalculoTotal(i); ActualizaValores(); CapturarDigitacion(i)">-->
                <!-- <input
                  type="hidden"
                  name="CantidadModel{{ i }}"
                  [value]="item.Cantidad"
                /> -->
                <input
                  formControlName="Cantidad"
                  type="number"
                  min="1"
                  class="form-control form-control-sm text-right f-9"
                  (input)="CalculoTotal(i)"
                /><!-- ; CapturarDigitacion(i) (keyup)="ActualizaValores()"-->
              </td>
              <td>
                <!-- <input
                  type="hidden"
                  name="CostoModel{{ i }}"
                  [value]="item.Costo"
                /> -->
                <ng-container *ngIf="!item.editCosto; else inputEditCosto">
                  <div class="d-flex justify-content-between align-items-center">
                    <i role="button" (click)="item.editCosto = true" class="fas fa-pen fa-sm"></i>
                    <span>${{ formCompra.value.Productos[i].Costo | currency : "COP" : "symbol" }}</span>
                  </div>
                </ng-container>

                <ng-template #inputEditCosto>
                  <input
                    appAutoFocusDirective
                    (blur)="item.editCosto = false"
                    formControlName="Costo"
                    type="number"
                    min="1"
                    class="form-control form-control-sm text-right f-9"
                    (input)="CalculoTotal(i)"

                  /><!-- pattern="[0-9\.]*" ; CapturarDigitacion(i) -->
                </ng-template>
              </td>
              <td>
                <!-- <input
                  id="Iva{{ i }}"
                  name="Iva{{ i }}"
                  [ngModel]="item.Iva"
                  type="number"
                  min="1"
                  class="form-control form-control-sm text-right f-9"
                  (change)="
                    CalculoTotal(i); ActualizaValores(); CapturarDigitacion(i)
                  "
                /> -->
                <!-- <input
                  type="hidden"
                  name="IvaModel{{ i }}"
                  [value]="item.Iva"
                /> -->
                <!-- <mat-form-field class="pb-0" appearance="outline">
                  <mat-select
                    [ngModel]="item.Iva"
                    id="Iva{{ i }}"
                    name="Iva{{ i }}"
                    (selectionChange)="
                      CalculoTotal(i); ActualizaValores(); CapturarDigitacion(i)
                    "
                  >
                    <mat-option
                      *ngFor="let Impuesto of Impuestos; let i = index"
                      [value]="Impuesto.Valor"
                    >
                      {{ Impuesto.Valor }}</mat-option
                    >
                  </mat-select>
                </mat-form-field> -->
                <select
                  formControlName="Iva"
                  class="form-control form-control-sm"
                  (change)="CalculoTotal(i)"
                >
                  <!-- ; CapturarDigitacion(i) -->
                  <option
                    *ngFor="let Impuesto of Impuestos; let i = index"
                    [value]="Impuesto.Valor"
                  >
                    {{ Impuesto.Valor }}
                  </option>
                </select>
              </td>
              <td class="text-center align-middle">
                <input type="hidden" formControlName="Total" />
                <!-- <input
                  type="hidden"
                  name="TotalModel{{ i }}"
                  [value]="item.Total"
                /> -->
                <span name="Total{{ i }}" id="Total{{ i }}" type="text" readonly
                  ><!-- (change)=" CalculoTotal(i); ActualizaValores(); CapturarDigitacion(i)" -->
                  $ {{ item.Total | currency : "COP" : "symbol" }}
                </span>
              </td>
              <td class="align-middle">
                <button
                  class="btn btn-danger btn-sm"
                  (click)="deleteProduct(i, $event)"
                  *ngIf="item.producto != ''"
                >
                  <i class="fa fa-trash"></i>
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="row d-flex justify-content-end">
        <div class="col-sm-5">
          <table class="table table-hover">
            <tbody>
              <tr>
                <th>( = ) Subtotal :</th>
                <td class="d-flex justify-content-end">
                  $ {{ Subtotal_F | currency : "COP" }}
                </td>
              </tr>
              <tr>
                <th>( + ) Iva :</th>
                <td class="d-flex justify-content-end">
                  $ {{ Iva_F | currency : "COP" }}
                </td>
              </tr>
              <tr>
                <th>( = ) Total :</th>
                <td class="d-flex justify-content-end">
                  $ {{ Total_F | currency : "COP" }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
      <div class="row d-flex justify-content-center">
        <div class="col-sm-12 text-center">
          <button
            type="button"
            [disabled]="!formCompra.valid"
            class="btn btn-primary btn-lg btn-block"
            (click)="GuardarCompra()"
          >
            <i class="fas fa-save"></i>
            Realizar Compra
          </button>
        </div>
      </div>
    </div>
  </div>
</form>

<div class="row invoice-contact" style="align-items: flex-start !important">
  <div class="col-md-8">
    <div class="invoice-box row">
      <div class="col-sm-12">
        <table
          class="table invoice-table table-borderless"
          style="text-align: left; font-size: 12px"
        >
          <tbody>
            <tr>
              <td style="width: 100px">
                <!--  <img src="{{globales.urlLogoColor}}" class="m-b-10 img-60" alt="Pro-H Software"> -->
              </td>
              <td>
                <!-- TODO DATOS DE EMPRESA -->
                <!-- {{globales.Nombre}}
                                              <br> {{globales.Nit}}
                                              <br> {{globales.Direccion}}
                                              <br> {{globales.Telefono}} -->
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<ng-template #notData>
  <app-not-data [loading]="Cargando"></app-not-data>
</ng-template>
