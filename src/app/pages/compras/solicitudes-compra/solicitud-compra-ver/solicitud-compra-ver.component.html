<ng-template #placeholder>
  <app-placeholder-form></app-placeholder-form>
</ng-template>
<ng-container *ngIf="!loading; else placeholder">
  <div class="row">
    <!-- Historial  -->
    <div class="col-md-3">
      <div class="card">
        <div class="card-body">
          <div class="card-title">
            <h5 class="text-primary">Seguimiento</h5>
          </div>
          <hr class="line" />

          <ul class="list-group list-group-flush">
            <li class="list-group-item px-0">
              <div class="d-flex w-100 justify-content-between">
                <div>
                  <h6 class="mb-0">
                    <!-- faltan las actividades -->
                    <span class="badge"> </span>
                  </h6>
                </div>
                <!--  falta poner la imagen del funcionario  -->
                <img
                  class="d-block img-thumbnail rounded-circle img-fluid header-profile-user"
                  [src]="'../../../../../assets/images/noprofile.png'"
                />
              </div>
            </li>
          </ul>
        </div>
      </div>
    </div>
    <!-- Contenido principal -->
    <div class="col-md-9">
      <div class="card">
        <div class="card-body">
          <app-cabecera [datosCabecera]="datosCabecera"></app-cabecera>
          <hr class="line" />
          <!-- Tablas con información -->
          <div class="rounded-top table-responsive mt-2">
            <table class="table table-bordered table-striped table-sm">
              <thead class="bg-light">
                <tr class="text-center text-uppercase">
                  <th style="text-align: center">Funcionario que solicita</th>
                  <th style="text-align: center">Area o departamento</th>
                  <th style="text-align: center">Fecha de solicitud</th>
                  <th style="text-align: center">Fecha Probable de Entrega</th>
                </tr>
              </thead>
              <tbody>
                <tr class="text-center">
                  <td>
                    {{ solicitud.person.full_names | titlecase }}
                  </td>
                  <td>
                    {{
                      solicitud.person.contractultimate.position.dependency.name
                        | capitalLetter
                    }}
                  </td>
                  <td>
                    {{ solicitud.created_at | date : "MMM d, y" }}
                  </td>
                  <td>
                    {{ solicitud.expected_date | date : "MMM d, y" }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <hr />
          <h6>Productos</h6>
          <div class="rounded-top table-responsive">
            <table class="table table-bordered table-striped table-sm">
              <thead class="bg-light">
                <tr class="text-center text-uppercase">
                  <th>#</th>
                  <th>Referencia</th>
                  <th>Producto</th>
                  <th>Cantidad</th>
                  <th>Unidad Medida</th>
                  <th>Estado</th>
                  <th>Cotizaciones</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="
                    let product of solicitud.product_purchase_request;
                    let i = index
                  "
                  class="text-center"
                >
                  <th>
                    {{ i + 1 }}
                  </th>
                  <td class="align-middle">
                    {{ product.product.Referencia | uppercase }}
                  </td>
                  <td class="align-middle">
                    {{ product.name | uppercase }}
                  </td>
                  <td class="align-middle">
                    {{ product.ammount | number }}
                  </td>
                  <td class="align-middle">
                    {{ product.product.unit.name }}
                  </td>
                  <td class="align-middle">
                    {{ product.status }}
                  </td>

                  <td class="align-middle">
                    <div ngbDropdown container="body" class="dropdown-primary">
                      <button
                        ngbDropdownToggle
                        class="btn btn-primary btn-sm"
                        type="button"
                      >
                        <i class="mdi mdi-chevron-down"></i>
                      </button>
                      <div ngbDropdownMenu>
                        <a
                          class="dropdown-item text-info"
                          href="javascript: void(0);"
                          *ngIf="product.quotation.length == 0"
                          (click)="openModal(cotizacion_regular, product.id)"
                        >
                          <i class="fas fa-cloud-upload-alt"></i> Cargar
                        </a>
                        <a
                          class="dropdown-item text-success"
                          href="javascript: void(0);"
                          (click)="openModal2(cotizacion_nuevo_proveedor)"
                        >
                          <i class="fas fa-check"></i> Aprobar
                        </a>
                      </div>
                    </div>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <div class="rounded-top table-responsive">
            <table class="table table-borderless table-sm">
              <thead class="bg-light">
                <tr class="text-uppercase">
                  <th class="bg-light">Observaciones</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>
                    {{ solicitud.observations | uppercase }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <!-- Fin tablas con información -->
        </div>
      </div>
    </div>
  </div>
</ng-container>

<!--  Modal cotizar proveedor existente -->
<ng-template #cotizacion_regular let-modal>
  <div class="modal-header">
    <h4 class="text-primary modal-title">Cotizaciones material</h4>
    <button
      type="button"
      class="close"
      data-dismiss="modal"
      aria-label="Close"
      (click)="modal.dismiss()"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="modal-body">
    <button type="button" class="btn btn-primary" (click)="printForm()">
      Print
    </button>
    <ngb-tabset>
      <ng-container [formGroup]="formCotizacionRegular">
        <ng-container formArrayName="items">
          <ngb-tab
            *ngFor="let item of items.controls; let i = index"
            [title]="'Cotización ' + (i + 1)"
          >
            <ng-template ngbTabContent>
              <ng-container [formGroupName]="i">
                <div class="row mt-3">
                  <mat-form-field class="col" appearance="outline">
                    <mat-label>Nombre proveedor {{ i + 1 }}</mat-label>
                    <mat-select
                      formControlName="third_party_id"
                      required
                      [disableOptionCentering]="true"
                      #selectProveedor
                    >
                      <mat-select-filter
                        *ngIf="selectProveedor.focused"
                        [placeholder]="'Selecciona el proveedor'"
                        [array]="proveedores"
                        [displayMember]="'text'"
                        (filteredReturn)="filteredProveedor = $event"
                      ></mat-select-filter>
                      <mat-option
                        *ngFor="let proveedor of filteredProveedor"
                        [value]="proveedor.value"
                      >
                        {{ proveedor.text }}
                      </mat-option>
                    </mat-select>
                    <button
                      mat-icon-button
                      matSuffix
                      (click)="redirectTercero()"
                    >
                      <mat-icon>add</mat-icon>
                    </button>
                  </mat-form-field>

                  <mat-form-field class="col" appearance="outline">
                    <mat-label>Número de cotización {{ i + 1 }}</mat-label>
                    <input matInput readonly formControlName="code" required />
                  </mat-form-field>
                  <mat-form-field class="col" appearance="outline">
                    <mat-label>Precio total cotización {{ i + 1 }}</mat-label>
                    <input
                      matInput
                      currencyMask
                      appInputPosition
                      [options]="mask.maskCOP"
                      placeholder="Digita el precio total de la cotización"
                      formControlName="total_price"
                      required
                      autocomplete="off"
                    />
                  </mat-form-field>

                  <div class="form-group text-center col-md-12">
                    <div class="custom-input-file col-md-12">
                      <input
                        type="file"
                        #fileInput
                        id="importFile"
                        accept=".pdf"
                        class="input-file"
                        (change)="onFileChanged($event, i)"
                      />
                      Cargar cotización {{ i + 1 }}
                    </div>
                    <div class="col-md-12 text-center">
                      <small *ngIf="item.get('file').value" class="text-success"
                        >Cotización cargada exitosamente</small
                      >
                    </div>
                  </div>
                </div>
                <div
                  class="alert alert-info col-md-12 text-center"
                  role="alert"
                >
                  Solo podrás cargar una vez las cotizaciones, puedes cargar una
                  o más cotizaciones de este producto.
                </div>
              </ng-container>
            </ng-template>
          </ngb-tab>
        </ng-container>
      </ng-container>
    </ngb-tabset>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-danger"
      (click)="modal.dismiss('Cross click')"
    >
      Cancelar
    </button>
    <button type="submit" class="btn btn-primary" (click)="saveQuotation()">
      Guardar
    </button>
  </div>
</ng-template>

<!--  Modal cotizar proveedor nuevo -->
<ng-template #cotizacion_nuevo_proveedor let-modal>
  <div class="modal-header">
    <h4 class="text-primary modal-title">Cotizaciones Material</h4>
    <button
      type="button"
      class="close"
      data-dismiss="modal"
      aria-label="Close"
      (click)="modal.dismiss()"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>

  <div class="modal-body"></div>
  <div class="modal-footer">
    <button type="button" class="btn btn-danger" (click)="modal.dismiss()">
      Cerrar
    </button>
  </div>
</ng-template>
