<div class="card">
  <div class="card-body">
    <app-cabecera [datosCabecera]="datosCabecera"></app-cabecera>
    <hr class="line" />
    <div class="d-flex justify-content-end">
      <div class="btn-group rounded w-sm-100" *ngIf="!Cargando">
        <button
          class="btn btn-primary btn-sm"
          title="Recargar datos iniciales (Terceros, PUC, Centros Costos)"
          (click)="reloadData()"
        >
          <i class="fa fa-refresh"></i> Recargar
        </button>
      </div>
    </div>
    <form #FormEgreso="ngForm" class="mt-2">
      <input hidden name="Id_Borrador" [(ngModel)]="idBorrador" />
      <div class="row">
        <mat-form-field class="col" appearance="outline">
          <mat-label>Fecha</mat-label>
          <input
            matInput
            type="date"
            name="Fecha_Documento"
            id="Fecha_Nota_Contable"
            [(ngModel)]="Fecha_Nota_Contable"
            (keyup)="tab($event, 'Cliente')"
            (change)="getCodigoEgreso($event.target.value)"
            required
            autocomplete="off"
          />
        </mat-form-field>
        <mat-form-field class="col" appearance="outline">
          <mat-label>Beneficiario</mat-label>
          <input
            matInput
            type="text"
            name="Cliente"
            id="Cliente"
            [(ngModel)]="Nom_Cliente"
            [ngbTypeahead]="search"
            [resultTemplate]="rt"
            (blur)="validarCampo(Nom_Cliente, $event, 'Beneficiario')"
            (keyup)="tab($event, 'Centro_Costo')"
            (ngModelChange)="BuscarDatosCliente(Nom_Cliente)"
            [inputFormatter]="formatter"
            required
            autocomplete="off"
          />
          <input
            hidden
            matInput
            [(ngModel)]="Id_Cliente"
            name="Beneficiario"
            id="Beneficiario"
            class="form-control form-control-sm"
            required
          />
          <input
            hidden
            matInput
            [(ngModel)]="Tipo_Beneficiario"
            name="Tipo_Beneficiario"
            id="Tipo_Beneficiario"
            class="form-control form-control-sm"
            required
          />
        </mat-form-field>
        <mat-form-field class="col" appearance="outline">
          <mat-label>Centro costo</mat-label>
          <input
            matInput
            type="text"
            name="Nom_Centro_Costo"
            [(ngModel)]="Nom_Centro_Costo"
            id="Centro_Costo"
            [ngbTypeahead]="search2"
            [resultTemplate]="rt2"
            [inputFormatter]="formatter2"
            (keyup)="tab($event, 'Documento')"
            (ngModelChange)="BuscarDatosCentro(Nom_Centro_Costo)"
            (blur)="validarCampo(Nom_Centro_Costo, $event, 'Centro de Costo')"
            required
            autocomplete="off"
          />
          <input
            hidden
            matInput
            name="Id_Centro_Costo"
            [(ngModel)]="Centro_Costo"
          />
        </mat-form-field>
        <mat-form-field class="col" appearance="outline">
          <mat-label>Documento</mat-label>
          <input
            matInput
            type="text"
            name="Documento"
            id="Documento"
            (keyup)="tab($event, 'Concepto')"
            [(ngModel)]="Documento"
            required
            autocomplete="off"
          />
        </mat-form-field>
        <mat-form-field class="col" appearance="outline">
          <mat-label>Forma de pago</mat-label>
          <mat-select
            name="Forma_Pago"
            id="forma_pago"
            [(ngModel)]="Forma_Pago"
            (selectionChange)="formaPago($event.target.value)"
          >
            <mat-option value="Cheque">Cheque</mat-option>
            <mat-option value="Transferencia">Transferencia</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field *ngIf="mostrarCheque" class="col" appearance="outline">
          <mat-label>Cheques</mat-label>
          <mat-select
            name="Cheques"
            [(ngModel)]="ChequesSeleccionados"
            [multiple]="true"
          >
            <mat-option *ngFor="let item of Cheques" [value]="item.value">{{
              item.label
            }}</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field
          class="col-md-12 mat-form-field-no-padding textarea"
          appearance="outline"
        >
          <mat-label>Concepto</mat-label>
          <textarea
            matInput
            placeholder="Ingresa el concepto"
            rows="5"
            name="Concepto"
            id="Concepto"
            (keyup)="tab($event, 'Cuenta0')"
            [(ngModel)]="Concepto"
            [cdkTextareaAutosize]="true"
          ></textarea>
        </mat-form-field>
        <!-- <div class="col-12">
          <app-borradorcomprobantes
            [Tipo_Comprobante]="Tipo_Comprobante"
            (Borrador)="setDatosBorrador($event)"
          ></app-borradorcomprobantes>
        </div> -->
      </div>
    </form>

    <ng-container *ngIf="Mostrar_Facturas">
      <h6 class="text-center">Facturas</h6>
      <div class="rounded-top table-responsive">
        <table class="table table-bordered table-striped table-sm">
          <thead class="bg-light">
            <tr class="text-center text-uppercase">
              <th></th>
              <th>Cuenta</th>
              <th>Fecha</th>
              <th>Documento</th>
              <th>Vlr. Factura</th>
              <th>Vlr. Abono</th>
              <th>Vlr. Saldo</th>
              <th>Abono</th>
              <th>Nat</th>
              <th>Movimiento Debito</th>
              <th>Movimiento_Credito</th>
            </tr>
          </thead>
          <tbody>
            <tr
              *ngIf="Lista_Facturas.length == 0 && !Cargando"
              class="text-center"
            >
              <td colspan="100%" class="p-5">
                <i class="fa fa-exclamation-circle fa-9x m-4"></i>
                <h4>No existen facturas para mostrar</h4>
              </td>
            </tr>
            <tr
              *ngFor="let item of Lista_Facturas; let i = index"
              id="fila{{ i }}"
            >
              <td class="text-center">
                <input
                  type="checkbox"
                  name="Factura{{ i }}"
                  id="Factura{{ i }}"
                  (change)="addListInvoice(item, i)"
                />
              </td>
              <td>{{ item.Codigo }}</td>
              <td>{{ item.Fecha }}</td>
              <td>{{ item.Factura }}</td>
              <td class="text-right">
                ${{ item.Valor_Factura | number : "1.2-2" }}
              </td>
              <td class="text-right">
                ${{ item.Valor_Abono | number : "1.2-2" }}
              </td>
              <td class="text-right">
                ${{ item.Valor_Saldo | number : "1.2-2" }}
              </td>
              <td class="text-right">
                <input
                  type="number"
                  name="abono{{ i }}"
                  id="abono{{ i }}"
                  [(ngModel)]="item.Abono"
                  (blur)="validarSaldoFactura(i, $event)"
                />
              </td>
              <td>{{ item.Nat }}</td>
              <td class="text-right">
                ${{ item.Movimiento_Debito | number : "1.2-2" }}
              </td>
              <td class="text-right">
                ${{ item.Movimiento_Credito | number : "1.2-2" }}
              </td>
            </tr>
            <tr *ngIf="Lista_Facturas.length > 0">
              <td colspan="7"></td>
              <td class="text-right">
                <b>Total: ${{ Total_Abono | number : "1.2-2" }}</b>
              </td>
              <td colspan="3"></td>
            </tr>
          </tbody>
        </table>
      </div>
      <button
        class="btn btn-primary btn-block btn-sm"
        (click)="addInvoicesToAccount()"
      >
        Confirmar
      </button>
    </ng-container>

    <hr />
    <div class="rounded-top table-responsive">
      <table class="table table-bordered table-striped table-sm">
        <thead class="bg-light">
          <tr class="text-center text-uppercase">
            <th>Cuenta</th>
            <!-- <th>Cheque</th> -->
            <th>Nit</th>
            <th>Centro Costo</th>
            <th>Documento</th>
            <th></th>
            <th>Concepto</th>
            <th>Base</th>
            <th>Debito</th>
            <th>Credito</th>
            <th>Deb Niif</th>
            <th>Cred Niif</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr
            *ngFor="let item of Cuentas_Contables; let i = index"
            id="fila{{ i }}"
          >
            <td>
              <input
                [(ngModel)]="item.Cuenta"
                type="text"
                name="Cuenta"
                id="Cuenta{{ i }}"
                class="form-control form-control-sm"
                [ngbTypeahead]="search1"
                [resultTemplate]="rt1"
                [inputFormatter]="formatter1"
                (keyup)="tab($event, 'Nit' + i)"
                (ngModelChange)="BuscarCuenta(item.Cuenta, i)"
                [required]="Cuentas_Contables.length - 1 != i"
                (blur)="
                  armarDatosBorrador();
                  validarCampo(item.Cuenta, $event, 'Cuenta')
                "
              />
            </td>
            <!-- <td>
              <select
                *ngIf="item.Cheque"
                name="cheque{{ i }}"
                id="cheque{{ i }}"
                [(ngModel)]="item.Cheque"
                class="form-control form-control-sm"
                (change)="armarDatosBorrador()"
                [required]="Cuentas_Contables.length - 1 != i"
              >
                <option value="">Seleccione</option>
                <option
                  *ngFor="let cheque of ChequesSeleccionados"
                  [value]="cheque"
                >
                  {{ cheque }}
                </option>
              </select>
            </td> -->
            <td>
              <input
                [(ngModel)]="item.Nit"
                type="text"
                name="Nit{{ i }}"
                id="Nit{{ i }}"
                (keyup)="tab($event, 'Centro_Costo' + i)"
                class="form-control form-control-sm f-9"
                [ngbTypeahead]="search"
                [resultTemplate]="rt"
                [inputFormatter]="formatter"
                (ngModelChange)="BuscarDatosCliente(item.Nit, i)"
                (blur)="
                  armarDatosBorrador(); validarCampo(item.Nit, $event, 'Nit')
                "
              />
            </td>
            <td>
              <input
                [(ngModel)]="item.Centro_Costo"
                type="text"
                name="Centro_Costo{{ i }}"
                id="Centro_Costo{{ i }}"
                class="form-control form-control-sm f-9"
                [ngbTypeahead]="search2"
                [resultTemplate]="rt2"
                [inputFormatter]="formatter2"
                (ngModelChange)="BuscarDatosCentro(item.Centro_Costo, i)"
                (keyup)="tab($event, 'Documento' + i)"
                (blur)="
                  armarDatosBorrador();
                  validarCampo(item.Centro_Costo, $event, 'Centro de Costo')
                "
              />
            </td>
            <td>
              <input
                name="Documento{{ i }}"
                id="Documento{{ i }}"
                (keyup)="tab($event, 'Concepto' + i)"
                [(ngModel)]="item.Documento"
                class="form-control form-control-sm text-right input-document"
                (blur)="armarDatosBorrador()"
                type="text"
              />
            </td>
            <td>
              <a href="javascript:;" (click)="showFacturas(item.Nit_Cuenta, i)">
                <i style="font-weight: bold" class="fa fa-search"></i>
              </a>
            </td>
            <td>
              <input
                name="Concepto{{ i }}"
                id="Concepto{{ i }}"
                (blur)="armarDatosBorrador()"
                (keyup)="tab($event, 'Base' + i)"
                [(ngModel)]="item.Concepto"
                class="form-control form-control-sm"
              />
            </td>

            <td>
              <input
                name="Base{{ i }}"
                id="Base{{ i }}"
                (blur)="armarDatosBorrador()"
                (keyup)="tab($event, 'Debito' + i)"
                (change)="calcularBase(i, $event.target.value)"
                [(ngModel)]="item.Base"
                class="form-control form-control-sm text-right"
                readonly
              />
            </td>
            <td>
              <input
                name="Debito{{ i }}"
                id="Debito{{ i }}"
                (blur)="armarDatosBorrador()"
                (keyup)="tab($event, 'Credito' + i)"
                (change)="ActualizaValores(i); validarDebCred(i, 'Debito')"
                [(ngModel)]="item.Debito"
                class="form-control form-control-sm text-right"
                type="number"
              />
            </td>
            <td>
              <input
                name="Credito{{ i }}"
                id="Credito{{ i }}"
                (blur)="armarDatosBorrador()"
                (keyup)="tab($event, 'Deb_Niif' + i)"
                (change)="ActualizaValores(i); validarDebCred(i, 'Credito')"
                [(ngModel)]="item.Credito"
                class="form-control form-control-sm text-right"
                type="number"
              />
            </td>
            <td>
              <input
                name="Deb_Niif{{ i }}"
                id="Deb_Niif{{ i }}"
                (blur)="armarDatosBorrador()"
                (keyup)="tab($event, 'Cred_Niif' + i)"
                (change)="validarDebCred(i, 'Debito')"
                [(ngModel)]="item.Deb_Niif"
                class="form-control form-control-sm text-right"
                type="number"
              />
            </td>
            <td>
              <input
                name="Cred_Niif{{ i }}"
                id="Cred_Niif{{ i }}"
                (blur)="armarDatosBorrador()"
                (keyup)="tab($event, 'Cuenta' + (i + 1))"
                (change)="validarDebCred(i, 'Credito')"
                [(ngModel)]="item.Cred_Niif"
                class="form-control form-control-sm text-right"
                type="number"
              />
            </td>
            <td class="text-center">
              <a
                *ngIf="Cuentas_Contables.length - 1 != i"
                href="javascript:;"
                (click)="EliminarCuenta(i); armarDatosBorrador()"
              >
                <span>
                  <i class="fa fa-trash-o text-danger"></i>
                </span>
              </a>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div class="rounded-top table-responsive">
      <table class="table table-bordered table-striped table-sm">
        <thead class="bg-light">
          <tr class="text-center text-uppercase">
            <th>Total Debito</th>
            <th>Total Credito</th>
            <th>Diferencia</th>
          </tr>
        </thead>
        <tbody>
          <tr class="text-center">
            <td>${{ Total_Debito | number : "1.2-2" }}</td>
            <td>${{ Total_Credito | number : "1.2-2" }}</td>
            <td>${{ Total_Debito - Total_Credito | number : "1.2-2" }}</td>
          </tr>
        </tbody>
      </table>
    </div>
    <button
      type="button"
      class="btn btn-primary btn-block"
      [swal]="confirmacionGuardar"
    >
      Guardar
    </button>
  </div>
</div>

<app-modal-basic #modalAgregarCheque>
  <div class="app-modal-header">
    <h4 class="modal-title">Registrar Cheque</h4>
    <button
      type="button"
      class="close basic-close"
      (click)="modalAgregarCheque.hide()"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="app-modal-body">
    <form #FormNuevoCheque="ngForm">
      <div class="row">
        <div class="col-md-12">
          <div class="form-group">
            <label for="banco">Banco</label>
            <ng-select
              id="banco"
              placeholder="Seleccione el Banco"
              class="f-9"
              [items]="Bancos"
              name="Id_Banco"
              [(ngModel)]="ModelCheque.Id_Plan_Cuentas"
              required
            ></ng-select>
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label for="prefijo">Prefijo</label>
            <input
              type="text"
              id="prefijo"
              name="prefijo"
              [(ngModel)]="ModelCheque.Prefijo"
              class="form-control form-control-sm"
              required
            />
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label for="inicial">Desde</label>
            <input
              type="number"
              id="inicial"
              name="inicial"
              [(ngModel)]="ModelCheque.Inicial"
              class="form-control form-control-sm"
              required
            />
          </div>
        </div>
        <div class="col-md-4">
          <div class="form-group">
            <label for="final">Hasta</label>
            <input
              type="number"
              id="final"
              name="final"
              [(ngModel)]="ModelCheque.Final"
              class="form-control form-control-sm"
              required
            />
          </div>
        </div>
      </div>
    </form>
  </div>
  <div class="app-modal-footer">
    <div class="text-right">
      <button
        type="button"
        class="btn btn-danger btn-sm"
        (click)="modalAgregarCheque.hide()"
      >
        Cancelar
      </button>
      <button
        type="button"
        [swal]="confirmacionGuardarCheque"
        [disabled]="!FormNuevoCheque.valid"
        class="btn btn-primary btn-sm"
      >
        Registrar
      </button>
    </div>
  </div>
</app-modal-basic>

<ng-template #rt let-r="result" let-t="term">
  <span class="f-9"
    ><strong>{{ r.Nombre }}</strong>
  </span>
</ng-template>
<swal #confirmacionSwal title="" text="" type=""></swal>

<swal #confirmacionGuardar [swalOptions]="alertOption"></swal>

<ng-template #rt1 let-r="result" let-t="term">
  <span class="f-9">{{ r.Codigo }} </span>
</ng-template>

<ng-template #rt2 let-r="result" let-t="term">
  <span class="f-9">{{ r.Nombre }} </span>
</ng-template>
<swal #confirmacionGuardarCheque [swalOptions]="alertOption2"></swal>
<!-- <a
      href="javascript:;"
      (click)="modalAgregarCheque.show()"
      placement="bottom"
      ngbTooltip="Registrar Nuevo Cheque"
      class="btn btn-outline-primary btn-sm pull-right m-r-20"
      ><i class="fa fa-plus"></i
    ></a> -->
<!-- <div class="col-md-2">
          <div class="form-group">
            <label>Empresa</label>
            <select
              [(ngModel)]="Id_Empresa"
              name="Id_Empresa"
              id="Id_Empresa"
              class="form-control form-control-sm"
              required
            >
              <option *ngFor="let item of companies" [value]="item.value">
                {{ item.text }}
              </option>
            </select>
          </div>
        </div> -->
