<ng-template #placeholder>
  <app-placeholder-form></app-placeholder-form>
</ng-template>
<form [formGroup]="form" *ngIf="!loading; else placeholder">
  <div [class]="preData ? '' : 'card'">
    <div class="card-body">
      <app-cabecera [datosCabecera]="datosCabecera"></app-cabecera>
      <hr class="line" />
      <div class="row">
        <mat-form-field class="col-md-4" appearance="outline">
          <mat-label>Nombre pieza</mat-label>
          <input
            matInput
            type="text"
            placeholder="Ingresa el nombre"
            formControlName="name"
            autocomplete="off"
            required
          />
        </mat-form-field>
        <mat-form-field class="col-md-4" appearance="outline">
          <mat-label>Conjunto</mat-label>
          <input
            matInput
            type="text"
            placeholder="Ingresa el conjunto"
            formControlName="set_name"
            autocomplete="off"
          />
        </mat-form-field>
        <mat-form-field class="col-md-4" appearance="outline">
          <mat-label>Máquina</mat-label>
          <input
            matInput
            type="text"
            placeholder="Ingresa la máquina"
            formControlName="machine_name"
            autocomplete="off"
          />
        </mat-form-field>
        <div class="col-md-6 mat-form-field-wrapper">
          <ng-select
            formControlName="city_id"
            [items]="cities"
            bindLabel="text"
            [class.is-invalid]="form.get('city_id')?.invalid"
            appearance="outline"
            [appendTo]="'body'"
            [clearable]="false"
            placeholder="Destino *"
            bindValue="value"
            loadingText="loading"
          >
          </ng-select>
        </div>
        <div class="col-md-6 mat-form-field-wrapper">
          <ng-select
            formControlName="third_party_id"
            [items]="clients"
            [clearable]="false"
            bindLabel="text"
            appearance="outline"
            [class.is-invalid]="form.get('third_party_id')?.invalid"
            [appendTo]="'body'"
            placeholder="Cliente *"
            bindValue="value"
            loadingText="loading"
            ngDefaultControl
          >
          </ng-select>
        </div>
        <mat-form-field class="col" appearance="outline">
          <mat-label>Línea</mat-label>
          <input
            matInput
            type="text"
            autocomplete="off"
            required
            placeholder="Ingresa la línea"
            formControlName="line"
          />
        </mat-form-field>
        <mat-form-field class="col" appearance="outline">
          <mat-label>Cantidad</mat-label>
          <input
            matInput
            currencyMask
            autocomplete="off"
            appInputPositionInitial
            [options]="masksMoney?.maskNumbers"
            required
            placeholder="Ingresa la cantidad"
            formControlName="amount"
          />
        </mat-form-field>
        <mat-form-field
          class="col-md-12 mat-form-field-no-padding textarea"
          appearance="outline"
        >
          <mat-label>Observaciones</mat-label>
          <textarea
            matInput
            placeholder="Ingrese las observaciones"
            rows="5"
            formControlName="observation"
            [cdkTextareaAutosize]="true"
          ></textarea>
        </mat-form-field>
      </div>
    </div>
  </div>
  <div class="card">
    <div class="card-body">
      <h6 class="mt-2 text-center">Costos directos</h6>
      <hr class="line" />
      <app-planos
        *ngIf="planos?.length > 0 && title == 'Editar pieza'"
        (actualizar)="refreshData()"
        [data]="planos"
        [info]="'editar'"
      ></app-planos>
      <h6>Subir planos</h6>
      <ngx-dropzone
        class="drop-zone"
        (change)="onSelect($event)"
        accept="image/jpeg, image/jpg, image/png, application/pdf"
      >
        <ngx-dropzone-label>
          <span><i class="fas fa-cloud-download-alt"></i></span>
          Arrastre y suelte el archivo
        </ngx-dropzone-label>
        <ngx-dropzone-preview
          *ngFor="let f of files"
          [removable]="true"
          (removed)="onRemove(f)"
        >
          <ngx-dropzone-label>{{ f?.name }} ({{ f?.type }})</ngx-dropzone-label>
        </ngx-dropzone-preview>
      </ngx-dropzone>
      <h6 class="mt-3">Cálculo de materia prima</h6>
      <ng-container *ngIf="materiaList?.controls?.length; else notData">
        <ng-container *ngFor="let item of materiaList?.controls; let i = index">
          <div class="rounded-top table-responsive">
            <table
              class="table table-bordered table-striped table-sm table-text-small"
              formArrayName="materia_prima"
            >
              <ng-container [formGroupName]="i">
                <thead class="bg-light">
                  <tr class="text-center text-uppercase">
                    <th class="align-middle">Item</th>
                    <th class="align-middle">Geometría</th>
                    <th class="align-middle">Foto</th>
                    <th class="align-middle">Material</th>
                    <th
                      class="align-middle col-1"
                      *ngFor="
                        let item of item['controls']['measures']['controls']
                      "
                    >
                      {{ item?.controls?.name?.value }}
                    </th>
                    <th class="align-middle">Peso KG</th>
                    <th class="align-middle">Cantidad</th>
                    <th class="align-middle">Peso Total</th>
                    <th class="align-middle">Valor KG</th>
                    <th class="align-middle">Valor Total</th>
                    <th class="align-middle">
                      <i class="fas fa-trash-alt"></i>
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr class="text-center">
                    <td class="align-middle">
                      {{ i + 1 }}
                    </td>
                    <td class="align-middle">
                      <select
                        class="form-control form-control-sm form-control-edit"
                        formControlName="geometry_id"
                      >
                        <option
                          *ngFor="let item of geometries"
                          [value]="item.value"
                        >
                          {{ item.text }}
                        </option>
                      </select>
                    </td>
                    <td class="align-middle p-0">
                      <img
                        [src]="item?.controls?.image?.value"
                        class="img-fluid img-geometry"
                        onerror="this.src='../../../../../assets/images/product.jpg'"
                      />
                    </td>
                    <td class="align-middle">
                      <select
                        class="form-control form-control-sm form-control-edit"
                        formControlName="material_id"
                      >
                        <option
                          *ngFor="let item of materials"
                          [value]="item.id"
                        >
                          {{ item.text }}
                        </option>
                      </select>
                    </td>
                    <ng-container formArrayName="measures">
                      <ng-container
                        [formGroupName]="j"
                        *ngFor="
                          let item of item?.controls?.measures?.controls;
                          let j = index
                        "
                      >
                        <td class="align-middle">
                          <input
                            currencyMask
                            appInputPositionInitial
                            [options]="masksMoney?.maskNumbers3Decimal"
                            class="form-control form-control-sm form-control-edit"
                            formControlName="value"
                          />
                        </td>
                      </ng-container>
                    </ng-container>
                    <td class="align-middle">
                      {{ item?.controls?.weight_kg?.value | number }}
                    </td>
                    <td class="align-middle">
                      {{ item?.controls?.q?.value | number }}
                    </td>
                    <td class="align-middle">
                      {{ item?.controls?.weight_total?.value | number }}
                    </td>
                    <td class="align-middle">
                      ${{ item?.controls?.value_kg?.value | number : "1.2-2" }}
                    </td>
                    <td class="align-middle">
                      ${{
                        item?.controls?.total_value?.value | number : "1.2-2"
                      }}
                    </td>
                    <td class="align-middle">
                      <button
                        class="btn btn-danger btn-sm"
                        placement="bottom"
                        type="button"
                        ngbTooltip="Borrar"
                        (click)="deleteMateria(i)"
                      >
                        <i class="fas fa-trash-alt"></i>
                      </button>
                    </td>
                  </tr>
                </tbody>
              </ng-container>
            </table>
          </div>
        </ng-container>
      </ng-container>
      <button
        class="btn btn-primary btn-block btn-sm"
        placement="bottom"
        type="button"
        ngbTooltip="Agregar"
        (click)="newMateria()"
      >
        <i class="fas fa-plus"></i>
        Agregar materia prima
      </button>
      <ng-container *ngIf="materiaList?.controls?.length">
        <app-list-items
          title1="SUBTOTAL"
          [var1]="this?.form?.get('subtotal_raw_material')?.value"
          type1="cop"
          mt="mt-2"
        ></app-list-items>
      </ng-container>
      <hr />
      <h6 class="mt-3">Materiales comerciales</h6>
      <ng-container *ngIf="materialsList?.controls?.length; else notData">
        <div class="rounded-top table-responsive">
          <table
            class="table table-bordered table-striped table-sm table-text-small"
          >
            <thead class="bg-light">
              <tr class="text-center text-uppercase">
                <th class="align-middle">Item</th>
                <th class="align-middle">Material</th>
                <th class="align-middle">Unidad</th>
                <th class="align-middle">Cant. Unitaria</th>
                <th class="align-middle">Cant. Total</th>
                <th class="align-middle">Costo Unitario</th>
                <th class="align-middle">Total</th>
                <th class="align-middle">
                  <i class="fas fa-trash-alt"></i>
                </th>
              </tr>
            </thead>
            <tbody formArrayName="commercial_materials">
              <ng-container
                *ngFor="let item of materialsList?.controls; let i = index"
              >
                <tr [formGroupName]="i" class="text-center">
                  <td class="align-middle">
                    {{ i + 1 }}
                  </td>
                  <td class="align-middle">
                    <p-dropdown
                      [options]="materialsIndex"
                      formControlName="material_id"
                      optionLabel="text"
                      [filter]="true"
                      filterBy="text"
                      appendTo="body"
                      optionValue="id"
                    ></p-dropdown>
                  </td>
                  <td class="align-middle">
                    <select
                      class="form-control form-control-sm form-control-edit"
                      id="unidad_materiales"
                      formControlName="unit_id"
                    >
                      <option value="" disabled selected hidden>
                        Selecciona
                      </option>
                      <option *ngFor="let item of units" [value]="item?.value">
                        {{ item?.text }}
                      </option>
                    </select>
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers2Decimal"
                      class="form-control form-control-sm form-control-edit"
                      id="q_unitaria_materiales"
                      formControlName="q_unit"
                    />
                  </td>
                  <td class="align-middle">
                    {{ item?.controls?.q_total?.value | number }}
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPosition
                      [options]="masksMoney?.maskCOP"
                      class="form-control form-control-sm form-control-edit"
                      id="costo_unitario_materiales"
                      formControlName="unit_cost"
                    />
                  </td>
                  <td class="align-middle">
                    ${{ item?.controls?.total?.value | number : "1.2-2" }}
                  </td>
                  <td class="align-middle">
                    <button
                      class="btn btn-danger btn-sm"
                      placement="bottom"
                      type="button"
                      ngbTooltip="Borrar"
                      (click)="deleteMaterial(i)"
                    >
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </ng-container>
      <button
        class="btn btn-primary btn-block btn-sm"
        placement="bottom"
        type="button"
        ngbTooltip="Agregar"
        (click)="newMaterial()"
      >
        <i class="fas fa-plus"></i>
        Agregar material comercial
      </button>
      <ng-container *ngIf="materialsList?.controls?.length">
        <app-list-items
          title1="SUBTOTAL"
          [var1]="this?.form?.get('commercial_materials_subtotal')?.value"
          type1="cop"
          mt="mt-2"
        ></app-list-items>
      </ng-container>
      <hr />
      <div class="d-flex justify-content-between">
        <h6 class="mt-3">Corte agua</h6>
        <mat-form-field appearance="outline" class="pb-0" style="width: 6rem">
          <mat-label>Valor minuto</mat-label>
          <input
            matInput
            currencyMask
            appInputPosition
            formControlName="minute_value_water"
            [options]="masksMoney?.maskCOP"
            placeholder="Valor minuto"
          />
        </mat-form-field>
      </div>
      <ng-container *ngIf="cutWaterList?.controls?.length; else notData">
        <div class="rounded-top table-responsive">
          <table
            class="table table-bordered table-striped table-sm table-text-small"
          >
            <thead class="bg-light">
              <tr class="text-center text-uppercase">
                <th class="align-middle">Item</th>
                <th class="align-middle">Material</th>
                <th class="align-middle">Espesor(mm)</th>
                <th class="align-middle">Cantidad</th>
                <th class="align-middle">Largo(mm)</th>
                <th class="align-middle">Ancho(mm)</th>
                <th class="align-middle">Longitud total</th>
                <th class="align-middle">Cantidad</th>
                <th class="align-middle">Diámetro(mm)</th>
                <th class="align-middle">Perim total agujero</th>
                <th class="align-middle">Tiempo (min)</th>
                <th class="align-middle">Valor Minuto</th>
                <th class="align-middle">Valor</th>
                <th class="align-middle">
                  <i class="fas fa-trash-alt"></i>
                </th>
              </tr>
            </thead>
            <tbody formArrayName="cut_water">
              <ng-container
                *ngFor="let item of cutWaterList?.controls; let i = index"
              >
                <tr [formGroupName]="i" class="text-center">
                  <td class="align-middle">
                    {{ i + 1 }}
                  </td>
                  <td class="align-middle">
                    <select
                      name=""
                      class="form-control form-control-sm form-control-edit"
                      style="width: 9rem"
                      id="material_corte_agua"
                      formControlName="material_id"
                    >
                      <option value="" disabled selected hidden>
                        Selecciona
                      </option>
                      <option *ngFor="let item of materials" [value]="item?.id">
                        {{ item?.text }}
                      </option>
                    </select>
                  </td>
                  <td class="align-middle">
                    <select
                      class="form-control form-control-sm form-control-edit"
                      id="espesor_corte_agua"
                      formControlName="thickness_id"
                    >
                      <option value="" disabled selected hidden>
                        Selecciona
                      </option>
                      <option
                        *ngFor="let item of thicknesses"
                        [value]="item?.id"
                      >
                        {{ item?.thickness }}
                      </option>
                    </select>
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm form-control-edit"
                      id="cantidad_corte_agua"
                      formControlName="amount"
                    />
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm form-control-edit"
                      id="largo_corte_agua"
                      formControlName="long"
                    />
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm form-control-edit"
                      id="ancho_corte_agua"
                      formControlName="width"
                    />
                  </td>
                  <td class="align-middle">
                    {{ item?.controls?.total_length?.value | number }}
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm form-control-edit"
                      id="cantidad_corte_corte_agua"
                      formControlName="amount_cut"
                    />
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm form-control-edit"
                      id="diametro_corte_corte_agua"
                      formControlName="diameter"
                    />
                  </td>
                  <td class="align-middle">
                    {{
                      item?.controls?.total_hole_perimeter?.value
                        | number : "1.2-2"
                    }}
                  </td>
                  <td class="align-middle">
                    {{ item?.controls?.time?.value | number : "1.2-2" }}
                  </td>
                  <td class="align-middle">
                    ${{
                      item?.controls?.minute_value?.value | number : "1.2-2"
                    }}
                  </td>
                  <td class="align-middle">
                    ${{ item?.controls?.value?.value | number : "1.2-2" }}
                  </td>
                  <td class="align-middle">
                    <button
                      class="btn btn-danger btn-sm"
                      placement="bottom"
                      type="button"
                      ngbTooltip="Borrar"
                      (click)="deleteCutWater(i)"
                    >
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </ng-container>
      <button
        class="btn btn-primary btn-block btn-sm"
        placement="bottom"
        type="button"
        ngbTooltip="Agregar"
        (click)="newCutWater()"
      >
        <i class="fas fa-plus"></i>
        Agregar material de corte agua
      </button>
      <ng-container *ngIf="cutWaterList?.controls?.length">
        <app-list-items
          title1="CANTIDAD TOTAL"
          [var1]="this?.form?.get('cut_water_total_amount')?.value"
          type1="amount"
          title2="SUBTOTAL UNITARIO"
          [var2]="this?.form?.get('cut_water_unit_subtotal')?.value"
          type2="cop"
          title3="SUBTOTAL"
          [var3]="this?.form?.get('cut_water_subtotal')?.value"
          type3="cop"
          mt="mt-2"
        ></app-list-items>
      </ng-container>
      <hr />
      <div class="d-flex justify-content-between">
        <h6 class="mt-3">Corte láser</h6>
        <mat-form-field appearance="outline" class="pb-0" style="width: 6rem">
          <mat-label>Valor minuto</mat-label>
          <input
            matInput
            currencyMask
            appInputPosition
            formControlName="minute_value_laser"
            [options]="masksMoney?.maskCOP"
            placeholder="Valor minuto"
          />
        </mat-form-field>
      </div>
      <ng-container *ngIf="cutLaserList?.controls?.length; else notData">
        <div class="rounded-top table-responsive">
          <table
            class="table table-bordered table-striped table-sm table-text-small"
          >
            <thead class="bg-light">
              <tr class="text-center text-uppercase">
                <th class="align-middle">Item</th>
                <th class="align-middle">Material</th>
                <th class="align-middle">Espesor(mm)</th>
                <th class="align-middle">Cantidad láminas</th>
                <th class="align-middle">Largo(mm)</th>
                <th class="align-middle">Ancho(mm)</th>
                <th class="align-middle">Longitud total</th>
                <th class="align-middle">Cant. agujeros</th>
                <th class="align-middle">Diámetro(mm)</th>
                <th class="align-middle">Perim total agujero</th>
                <th class="align-middle">Tiempo (min)</th>
                <th class="align-middle">Valor Minuto</th>
                <th class="align-middle">Valor</th>
                <th class="align-middle">
                  <i class="fas fa-trash-alt"></i>
                </th>
              </tr>
            </thead>
            <tbody formArrayName="cut_laser">
              <ng-container
                *ngFor="let item of cutLaserList?.controls; let i = index"
              >
                <tr [formGroupName]="i" class="text-center">
                  <td class="text-center">
                    {{ i + 1 }}
                  </td>
                  <td class="text-center">
                    <select
                      name=""
                      class="form-control form-control-sm form-control-edit"
                      id="material_corte_laser"
                      style="width: 9rem"
                      formControlName="cut_laser_material_id"
                    >
                      <option value="" disabled selected hidden>
                        Selecciona
                      </option>
                      <option
                        *ngFor="let item of cutLaserMaterials"
                        [value]="item?.id"
                      >
                        {{ item?.name }}
                      </option>
                    </select>
                  </td>
                  <td class="text-center">
                    <select
                      class="form-control form-control-sm form-control-edit"
                      id="espesor_corte_laser"
                      formControlName="thicknessSelected"
                    >
                      <option
                        *ngFor="
                          let item of item['controls']['thicknesses']['value']
                        "
                        [value]="item?.id"
                      >
                        {{ item?.thickness }}
                      </option>
                    </select>
                  </td>
                  <td class="text-center">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm form-control-edit"
                      id="cantidad_corte_laser"
                      formControlName="sheets_amount"
                    />
                  </td>
                  <td class="text-center">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm form-control-edit"
                      id="largo_corte_laser"
                      formControlName="long"
                    />
                  </td>
                  <td class="text-center">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm form-control-edit"
                      id="ancho_corte_laser"
                      formControlName="width"
                    />
                  </td>
                  <td class="text-center">
                    {{ item?.controls?.total_length?.value | number }}
                  </td>
                  <td class="text-center">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm form-control-edit"
                      id="cantidad_agujeros_corte_laser"
                      formControlName="amount_holes"
                    />
                  </td>
                  <td class="text-center">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm form-control-edit"
                      id="diametro_corte_corte_laser"
                      formControlName="diameter"
                    />
                  </td>
                  <td class="text-center">
                    {{
                      item?.controls?.total_hole_perimeter?.value
                        | number : "1.2-2"
                    }}
                  </td>
                  <td class="text-center">
                    {{ item?.controls?.time?.value | number : "1.2-2" }}
                  </td>
                  <td class="text-center">
                    ${{
                      item?.controls?.minute_value?.value | number : "1.2-2"
                    }}
                  </td>
                  <td class="text-center">
                    ${{ item?.controls?.value?.value | number : "1.2-2" }}
                  </td>
                  <td class="text-center">
                    <button
                      class="btn btn-danger btn-sm"
                      placement="bottom"
                      type="button"
                      ngbTooltip="Borrar"
                      (click)="deleteCutLaser(i)"
                    >
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </ng-container>
      <button
        class="btn btn-primary btn-block btn-sm"
        placement="bottom"
        type="button"
        ngbTooltip="Agregar"
        (click)="newCutLaser()"
      >
        <i class="fas fa-plus"></i>
        Agregar material de corte láser
      </button>
      <ng-container *ngIf="cutLaserList?.controls?.length">
        <app-list-items
          title1="CANTIDAD TOTAL"
          [var1]="this?.form?.get('cut_laser_total_amount')?.value"
          type1="amount"
          title2="SUBTOTAL UNITARIO"
          [var2]="this?.form?.get('cut_laser_unit_subtotal')?.value"
          type2="cop"
          title3="SUBTOTAL"
          [var3]="this?.form?.get('cut_laser_subtotal')?.value"
          type3="cop"
          mt="mt-2"
        ></app-list-items>
      </ng-container>
      <hr />
      <h6 class="mt-3">Máquinas herramientas</h6>
      <ng-container *ngIf="machineToolList?.controls?.length; else notData">
        <div class="rounded-top table-responsive">
          <table class="table table-bordered table-striped table-sm">
            <thead class="bg-light">
              <tr class="text-center text-uppercase">
                <th class="align-middle">Item</th>
                <th class="align-middle">Descripción</th>
                <th class="align-middle">Unidad</th>
                <th class="align-middle col-1">Cant. Unitaria</th>
                <th class="align-middle col-1">Cant. Total</th>
                <th class="align-middle">Costo Unitario</th>
                <th class="align-middle">Total</th>
                <th class="align-middle">
                  <button
                    class="btn btn-danger btn-sm"
                    placement="bottom"
                    type="button"
                    ngbTooltip="Borrar todo"
                    (click)="deleteAllMachineTool()"
                  >
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </th>
              </tr>
            </thead>
            <tbody formArrayName="machine_tools">
              <ng-container
                *ngFor="let item of machineToolList?.controls; let i = index"
              >
                <tr [formGroupName]="i" class="text-center">
                  <td class="align-middle">
                    {{ i + 1 }}
                  </td>
                  <td class="align-middle">
                    {{ item?.value?.name_description | capitalLetter }}
                  </td>
                  <td class="align-middle">
                    {{ item?.value?.unit_name | capitalLetter }}
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm"
                      id="q_unitaria_maquinas_herra"
                      style="width: 6rem"
                      formControlName="q_unit"
                    />
                  </td>
                  <td class="align-middle font-weight-bold text-right">
                    {{ item?.value?.q_total }}
                  </td>
                  <td class="align-middle font-weight-bold text-right">
                    ${{ item?.value?.unit_cost | number : "1.2-2" }}
                  </td>
                  <td class="align-middle font-weight-bold text-right">
                    ${{ item?.value?.total | number : "1.2-2" }}
                  </td>
                  <td class="align-middle">
                    <button
                      class="btn btn-danger btn-sm"
                      placement="bottom"
                      type="button"
                      ngbTooltip="Borrar"
                      (click)="deleteMachineTool(i)"
                    >
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </ng-container>
      <button
        class="btn btn-primary btn-block btn-sm"
        placement="bottom"
        type="button"
        ngbTooltip="Agregar"
        (click)="newMachineTool()"
      >
        <i class="fas fa-plus"></i>
        Agregar máquinas herramientas
      </button>
      <ng-container *ngIf="machineToolList?.controls?.length">
        <app-list-items
          title1="SUBTOTAL"
          [var1]="this?.form?.get('machine_tools_subtotal')?.value"
          type1="cop"
          mt="mt-2"
        ></app-list-items>
      </ng-container>
      <hr />
      <h6 class="mt-3">Procesos internos</h6>
      <ng-container
        *ngIf="internalProccessList?.controls?.length; else notData"
      >
        <div class="rounded-top table-responsive">
          <table class="table table-bordered table-striped table-sm">
            <thead class="bg-light">
              <tr class="text-center text-uppercase">
                <th class="align-middle">Item</th>
                <th class="align-middle">Descripción</th>
                <th class="align-middle">Unidad</th>
                <th class="align-middle col-1">Cant. Unitaria</th>
                <th class="align-middle col-1">Cant. Total</th>
                <th class="align-middle">Costo Unitario</th>
                <th class="align-middle">Total</th>
                <th class="align-middle">
                  <button
                    class="btn btn-danger btn-sm"
                    placement="bottom"
                    type="button"
                    ngbTooltip="Borrar todo"
                    (click)="deleteAllInternalProccess()"
                  >
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </th>
              </tr>
            </thead>
            <tbody formArrayName="internal_proccesses">
              <ng-container
                *ngFor="
                  let item of internalProccessList?.controls;
                  let i = index
                "
              >
                <tr [formGroupName]="i" class="text-center">
                  <td class="align-middle">{{ i + 1 }}</td>
                  <td class="align-middle">
                    {{ item?.value?.name_description | capitalLetter }}
                  </td>
                  <td class="align-middle">
                    {{ item?.value?.unit_name | capitalLetter }}
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm"
                      id="q_unitaria_proceso_interno"
                      formControlName="q_unit"
                    />
                  </td>
                  <td class="align-middle font-weight-bold text-right">
                    {{ item?.value?.q_total }}
                  </td>
                  <td class="align-middle font-weight-bold text-right">
                    ${{ item?.value?.unit_cost | number : "1.2-2" }}
                  </td>
                  <td class="align-middle font-weight-bold text-right">
                    ${{ item?.value?.total | number : "1.2-2" }}
                  </td>
                  <td class="align-middle">
                    <button
                      class="btn btn-danger btn-sm"
                      placement="bottom"
                      type="button"
                      ngbTooltip="Borrar"
                      (click)="deleteInternalProccess(i)"
                    >
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </ng-container>
      <button
        class="btn btn-primary btn-block btn-sm"
        placement="bottom"
        type="button"
        ngbTooltip="Agregar"
        (click)="newInternalProccesses()"
      >
        <i class="fas fa-plus"></i>
        Agregar procesos internos
      </button>
      <ng-container *ngIf="internalProccessList?.controls?.length">
        <app-list-items
          title1="SUBTOTAL"
          [var1]="this?.form?.get('internal_proccesses_subtotal')?.value"
          type1="cop"
          mt="mt-2"
        ></app-list-items>
      </ng-container>
      <hr />
      <h6 class="mt-3">Procesos externos</h6>
      <ng-container
        *ngIf="externalProccessList?.controls?.length; else notData"
      >
        <div class="rounded-top table-responsive">
          <table class="table table-bordered table-striped table-sm">
            <thead class="bg-light">
              <tr class="text-center text-uppercase">
                <th class="align-middle">Item</th>
                <th class="align-middle">Descripción</th>
                <th class="align-middle">Unidad</th>
                <th class="align-middle col-1">Cant. Unitaria</th>
                <th class="align-middle col-1">Cant. Total</th>
                <th class="align-middle col-1">Costo Unitario</th>
                <th class="align-middle">Total</th>
                <th class="align-middle">
                  <button
                    class="btn btn-danger btn-sm"
                    placement="bottom"
                    type="button"
                    ngbTooltip="Borrar todo"
                    (click)="deleteAllExternalProccess()"
                  >
                    <i class="fas fa-trash-alt"></i>
                  </button>
                </th>
              </tr>
            </thead>
            <tbody formArrayName="external_proccesses">
              <ng-container
                *ngFor="
                  let item of externalProccessList?.controls;
                  let i = index
                "
              >
                <tr [formGroupName]="i" class="text-center">
                  <td class="align-middle">
                    {{ i + 1 }}
                  </td>
                  <td class="align-middle">
                    {{ item?.value?.name_description | capitalLetter }}
                  </td>
                  <td class="align-middle">
                    {{ item?.value?.unit_name | capitalLetter }}
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers3Decimal"
                      class="form-control form-control-sm"
                      id="q_unitaria_proceso_externo"
                      formControlName="q_unit"
                    />
                  </td>
                  <td class="align-middle">
                    {{ item?.value?.q_total }}
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPosition
                      [options]="masksMoney?.maskCOP"
                      class="form-control form-control-sm"
                      style="width: 8rem"
                      formControlName="unit_cost"
                    />
                    <!-- ${{ item?.value?.unit_cost | number : "1.2-2" }} -->
                  </td>
                  <td class="align-middle">
                    ${{ item?.value?.total | number : "1.2-2" }}
                  </td>
                  <td class="align-middle">
                    <button
                      class="btn btn-danger btn-sm"
                      placement="bottom"
                      type="button"
                      ngbTooltip="Borrar"
                      (click)="deleteExternalProccess(i)"
                    >
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </ng-container>
      <button
        class="btn btn-primary btn-block btn-sm"
        placement="bottom"
        type="button"
        ngbTooltip="Agregar"
        (click)="newExternalProccesses()"
      >
        <i class="fas fa-plus"></i>
        Agregar procesos externos
      </button>
      <ng-container *ngIf="externalProccessList?.controls?.length">
        <app-list-items
          title1="SUBTOTAL"
          [var1]="this?.form?.get('external_proccesses_subtotal')?.value"
          type1="cop"
          mt="mt-2"
        ></app-list-items>
      </ng-container>
      <hr />
      <h6>Otros</h6>
      <ng-container *ngIf="othersList?.controls?.length; else notData">
        <div class="rounded-top table-responsive">
          <table class="table table-bordered table-striped table-sm">
            <thead class="bg-light">
              <tr class="text-center text-uppercase">
                <th class="align-middle">Item</th>
                <th class="align-middle">Descripción</th>
                <th class="align-middle">Unidad</th>
                <th class="align-middle">Cant. Unitaria</th>
                <th class="align-middle">Cant. Total</th>
                <th class="align-middle">Costo Unitario</th>
                <th class="align-middle">Total</th>
                <th class="align-middle">
                  <i class="fas fa-trash-alt"></i>
                </th>
              </tr>
            </thead>
            <tbody formArrayName="others">
              <ng-container
                *ngFor="let item of othersList?.controls; let i = index"
              >
                <tr [formGroupName]="i" class="text-center">
                  <td class="align-middle">
                    {{ i + 1 }}
                  </td>
                  <td class="align-middle">
                    <textarea
                      class="form-control form-control-sm"
                      id="descripcion_otros"
                      style="min-width: 25rem"
                      placeholder="Ingresa descripción"
                      formControlName="description"
                      rows="1"
                    >
                    </textarea>
                  </td>
                  <td class="align-middle">
                    <select
                      name=""
                      class="form-control form-control-sm"
                      id="unidad_otros"
                      formControlName="unit_id"
                    >
                      <option value="" disabled selected hidden>
                        Selecciona
                      </option>
                      <option *ngFor="let item of units" [value]="item?.value">
                        {{ item?.text }}
                      </option>
                    </select>
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPositionInitial
                      [options]="masksMoney?.maskNumbers2Decimal"
                      class="form-control form-control-sm"
                      id="q_unitaria_otros"
                      formControlName="q_unit"
                    />
                  </td>
                  <td class="align-middle">
                    {{ item?.controls?.q_total?.value | number }}
                  </td>
                  <td class="align-middle">
                    <input
                      currencyMask
                      appInputPosition
                      [options]="masksMoney?.maskCOP"
                      class="form-control form-control-sm"
                      id="costo_unitario_otros"
                      formControlName="unit_cost"
                    />
                  </td>
                  <td class="align-middle">
                    ${{ item?.controls?.total?.value | number : "1.2-2" }}
                  </td>
                  <td class="align-middle">
                    <button
                      class="btn btn-danger btn-sm"
                      placement="bottom"
                      type="button"
                      ngbTooltip="Borrar"
                      (click)="deleteOthers(i)"
                    >
                      <i class="fas fa-trash-alt"></i>
                    </button>
                  </td>
                </tr>
              </ng-container>
            </tbody>
          </table>
        </div>
      </ng-container>
      <button
        class="btn btn-primary btn-block btn-sm"
        placement="bottom"
        type="button"
        ngbTooltip="Agregar"
        (click)="newOthersList()"
      >
        <i class="fas fa-plus"></i>
        Agregar otro
      </button>
      <ng-container *ngIf="othersList?.controls?.length">
        <app-list-items
          title1="SUBTOTAL"
          [var1]="this?.form?.get('others_subtotal')?.value"
          type1="cop"
          mt="mt-2"
        ></app-list-items>
      </ng-container>
      <hr />
      <app-list-items
        title1="COSTO DIRECTO TOTAL"
        [var1]="this?.form?.get('total_direct_cost')?.value"
        type1="cop"
        title2="COSTO DIRECTO UNITARIO"
        [var2]="this?.form?.get('unit_direct_cost')?.value"
        type2="cop"
      ></app-list-items>
      <div class="row mt-3">
        <div class="col-md-6">
          <a
            class="h6"
            data-toggle="collapse"
            data-target="#collapseIndirecto"
            role="button"
            aria-expanded="true"
            (click)="indirectCollapsed = !indirectCollapsed"
            aria-controls="collapseIndirecto"
          >
            <i
              class="fas"
              [class]="
                indirectCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'
              "
            ></i>
            Costos indirectos
          </a>
          <hr />
          <div class="collapse show" id="collapseIndirecto">
            <div class="rounded-top table-responsive">
              <table class="table table-borderless">
                <tbody class="text-uppercase">
                  <ng-container formArrayName="indirect_cost">
                    <ng-container
                      *ngFor="
                        let item of indirecCostList?.controls;
                        let i = index
                      "
                    >
                      <tr [formGroupName]="i">
                        <td class="col-7">{{ item?.controls?.name?.value }}</td>
                        <td class="col-2">
                          <input
                            currencyMask
                            appInputPositionInitial
                            [options]="masksMoney?.maskPorcentaje"
                            step=".1"
                            class="form-control form-control-sm"
                            formControlName="percentage"
                          />
                        </td>
                        <td class="col-3 text-right">
                          ${{ item?.controls?.value?.value | number : "1.2-2" }}
                        </td>
                      </tr>
                    </ng-container>
                  </ng-container>
                  <tr>
                    <th colspan="2" class="col-9 text-uppercase align-middle">
                      Costos indirectos
                    </th>
                    <th class="col-3 text-right align-middle">
                      ${{
                        form?.controls?.indirect_cost_total?.value
                          | number : "1.2-2"
                      }}
                      <!-- <input
                        currencyMask
                        appInputPosition
                        [options]="masksMoney?.maskCOP"
                        class="form-control form-control-sm"
                        formControlName="indirect_cost_total"
                      /> -->
                    </th>
                  </tr>
                  <tr>
                    <th colspan="2" class="col-9 align-middle">
                      Costos directos + costos indirectos totales
                    </th>
                    <th class="col-3 align-middle text-right">
                      ${{
                        form?.controls?.direct_costs_indirect_costs_total?.value
                          | number : "1.2-2"
                      }}
                    </th>
                  </tr>
                  <tr>
                    <th colspan="2" class="col-9 align-middle">
                      Costos directos + costos indirectos unitario
                    </th>
                    <th class="col-3 align-middle text-right">
                      ${{
                        form?.controls?.direct_costs_indirect_costs_unit?.value
                          | number : "1.2-2"
                      }}
                    </th>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <a
            class="h6"
            data-toggle="collapse"
            data-target="#collapseAUI"
            role="button"
            aria-expanded="true"
            (click)="auiCollapsed = !auiCollapsed"
            aria-controls="collapseAUI"
          >
            <i
              class="fas"
              [class]="auiCollapsed ? 'fa-chevron-right' : 'fa-chevron-down'"
            ></i>
            AIU
          </a>
          <hr />
          <div class="collapse show" id="collapseAUI">
            <div class="rounded-top table-responsive">
              <table class="table table-borderless">
                <tbody class="text-uppercase">
                  <tr>
                    <td class="col-7">Administrativos</td>
                    <td class="col-2">
                      <input
                        currencyMask
                        appInputPositionInitial
                        [options]="masksMoney?.maskPorcentaje"
                        class="form-control form-control-sm"
                        formControlName="administrative_percentage"
                      />
                    </td>
                    <td class="col-3 text-right">
                      ${{
                        form?.controls?.administrative_value?.value
                          | number : "1.2-2"
                      }}
                    </td>
                  </tr>
                  <tr>
                    <td class="col-7">Imprevistos</td>
                    <td class="col-2">
                      <input
                        currencyMask
                        appInputPositionInitial
                        [options]="masksMoney?.maskPorcentaje"
                        class="form-control form-control-sm"
                        formControlName="unforeseen_percentage"
                      />
                    </td>
                    <td class="col-3 text-right">
                      ${{
                        form?.controls?.unforeseen_value?.value
                          | number : "1.2-2"
                      }}
                    </td>
                  </tr>
                  <tr>
                    <td colspan="2" class="col-9">
                      SubTotal + Administrativos + Imprevistos
                    </td>
                    <td class="col-3 text-right">
                      ${{
                        form?.controls?.administrative_unforeseen_subtotal
                          ?.value | number : "1.2-2"
                      }}
                    </td>
                  </tr>
                  <tr>
                    <td class="col-9" colspan="2">
                      SubTotal + Administrativos + Imprevistos Unitario
                    </td>
                    <td class="col-3 text-right">
                      ${{
                        form?.controls?.administrative_unforeseen_unit?.value
                          | number : "1.2-2"
                      }}
                    </td>
                  </tr>
                  <tr>
                    <td colspan="2" class="col-9">Utilidad</td>
                    <td class="col-3">
                      <input
                        currencyMask
                        appInputPositionInitial
                        [options]="masksMoney?.maskPorcentaje"
                        class="form-control form-control-sm"
                        formControlName="utility_percentage"
                      />
                    </td>
                  </tr>
                  <tr>
                    <td colspan="2" class="col-9">
                      SubTotal + Admin + Imprevisto + Utilidad
                    </td>
                    <td class="col-3 text-right">
                      ${{
                        form?.controls?.admin_unforeseen_utility_subtotal?.value
                          | number : "1.2-2"
                      }}
                    </td>
                  </tr>
                  <tr>
                    <td colspan="2" class="col-9">
                      SubTotal + Admin + Imprevisto + Utilidad Unitario
                    </td>
                    <td class="col-3 text-right">
                      ${{
                        form?.controls?.admin_unforeseen_utility_unit?.value
                          | number : "1.2-2"
                      }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
          <div class="table-responsive">
            <table class="table table-borderless">
              <tbody class="text-uppercase">
                <tr class="table-primary">
                  <th class="col-9">Precio Venta Total COP + Retención</th>
                  <th class="col-3 text-right">
                    <h6>
                      <span>
                        $
                        {{
                          form?.get("sale_price_cop_withholding_total")?.value
                            | number : "1.2-2"
                        }}
                      </span>
                    </h6>
                  </th>
                </tr>
                <tr class="table-primary">
                  <th class="col-9">Valor de Venta Unitario COP</th>
                  <th class="col-3 text-right">
                    <h6>
                      <span>
                        $
                        {{
                          form?.get("sale_value_cop_unit")?.value
                            | number : "1.2-2"
                        }}
                      </span>
                    </h6>
                  </th>
                </tr>
                <tr>
                  <td class="col-9">TRM</td>
                  <td class="col-3">
                    <input
                      currencyMask
                      appInputPosition
                      [options]="masksMoney?.maskCOP"
                      class="form-control form-control-sm"
                      formControlName="trm"
                    />
                  </td>
                </tr>
                <tr class="table-primary">
                  <th class="col-9">Precio Venta Total USD + Retención</th>
                  <th class="col-3 text-right">
                    <h6>
                      <span>
                        USD
                        {{
                          form?.get("sale_price_usd_withholding_total")?.value
                            | number : "1.2-2"
                        }}
                      </span>
                    </h6>
                  </th>
                </tr>
                <tr class="table-primary">
                  <th class="col-9">Valor de Venta Unitario USD</th>
                  <th class="col-3 text-right">
                    <h6>
                      <span>
                        USD
                        {{
                          form?.get("sale_value_usd_unit")?.value
                            | number : "1.2-2"
                        }}
                      </span>
                    </h6>
                  </th>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <button
        *ngIf="!preData"
        class="btn btn-block btn-primary"
        (click)="save()"
      >
        Guardar
      </button>
    </div>
  </div>
</form>
<ng-template #notData>
  <div class="alert alert-warning text-center" role="alert">
    ¡No hay datos aquí!
  </div>
</ng-template>
<ng-template #notDataLoading>
  <app-not-data [loading]="loading"></app-not-data>
</ng-template>
<ng-template #wait>
  <div class="card">
    <div class="card-body">
      <div class="container p-4 text-center">
        <i class="fas fa-sync fa-spin fa-7x text-info"></i>
      </div>
    </div>
  </div>
</ng-template>

<app-reload-button
  [reload]="reload"
  (reloadData)="reloadData()"
></app-reload-button>
