<ng-template #newBusiness let-modal>
  <div class="modal-header">
    <h4 class="text-primary modal-title">Nuevo negocio</h4>
    <button
      type="button"
      class="close"
      data-dismiss="modal"
      aria-label="Close"
      (click)="_modal.close()"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <form [formGroup]="form">
      <div class="row">
        <mat-form-field class="col" appearance="outline">
          <mat-label>Nombre de la solicitud</mat-label>
          <input
            matInput
            id="request_name"
            type="text"
            placeholder="Ingresa el nombre"
            formControlName="name"
            name="solicitud"
            autocomplete="off"
            required
          />
        </mat-form-field>
        <mat-form-field class="col" appearance="outline">
          <mat-label>Fecha de entrega</mat-label>
          <input
            matInput
            id="date"
            type="date"
            [min]="today"
            formControlName="date"
            name="plazo"
            required
            autocomplete="off"
          />
        </mat-form-field>
        <div class="col mb-4">
          <ng-select
            [items]="companies"
            formControlName="third_party_id"
            placeholder="Compañía *"
            [appendTo]="'body'"
            appearance="outline"
            (change)="getContacts(); getBudgets(); getQuotations()"
            bindValue="value"
            bindLabel="text"
            required
          >
          </ng-select>
        </div>
        <div class="col mb-4">
          <ng-select
            [items]="contacts"
            formControlName="third_party_person_id"
            placeholder="Contacto *"
            bindLabel="text"
            [appendTo]="'body'"
            appearance="outline"
            bindValue="value"
            notFoundText="No hay registros"
          >
          </ng-select>
        </div>
        <div class="col mb-4">
          <ng-select
            [items]="countries"
            formControlName="country_id"
            placeholder="País *"
            (change)="filterDepartments($event.value)"
            bindLabel="text"
            [appendTo]="'body'"
            appearance="outline"
            bindValue="value"
            ngDefaultControl
            notFoundText="No hay registros"
          >
          </ng-select>
        </div>
        <div class="col mb-4">
          <ng-select
            [items]="cities"
            formControlName="city_id"
            bindLabel="text"
            bindValue="value"
            ngDefaultControl
            [appendTo]="'body'"
            appearance="outline"
            placeholder="Ciudad *"
            notFoundText="No hay registros"
          >
          </ng-select>
        </div>
        <mat-form-field
          class="col-md-12 mat-form-field-no-padding textarea"
          appearance="outline"
        >
          <mat-label>Descripción</mat-label>
          <textarea
            matInput
            placeholder="Ingrese la descripción"
            rows="5"
            formControlName="description"
            id="descripcion"
            name="description"
            required
            [cdkTextareaAutosize]="true"
          ></textarea>
        </mat-form-field>
      </div>
      <div class="mt-3">
        <div class="row">
          <div class="col-md mb-3">
            <h6>Presupuestos disponibles</h6>
          </div>
          <div class="col-md mb-3 text-right">
            <div class="btn-group rounded w-sm-100">
              <button
                class="btn btn-primary btn-sm"
                type="button"
                (click)="_modal.close()"
                [routerLink]="['/crm/presupuesto/crear']"
              >
                <i class="fa fa-plus"></i> Agregar
              </button>
            </div>
          </div>
        </div>
        <form [formGroup]="formFiltersBudgets">
          <div class="row">
            <mat-form-field class="col" appearance="outline">
              <mat-label>Item</mat-label>
              <input
                matInput
                type="text"
                placeholder="Busca por item"
                formControlName="item"
                autocomplete="off"
              />
            </mat-form-field>
            <mat-form-field class="col" appearance="outline">
              <mat-label>Cliente</mat-label>
              <input
                matInput
                type="text"
                placeholder="Busca por cliente"
                formControlName="customer"
                autocomplete="off"
              />
            </mat-form-field>
          </div>
        </form>
        <ng-container *ngIf="budgets.length > 0; else notDataAd">
          <div class="rounded-top table-responsive">
            <table
              class="table table-bordered table-striped table-sm mt-2"
              style="font-size: smaller"
            >
              <thead class="bg-light">
                <tr class="text-center text-uppercase">
                  <th>Item</th>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Destino</th>
                  <th>Linea</th>
                  <th>Quien elabora</th>
                  <th>Total COP</th>
                  <th>Total USD</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let item of budgets"
                  class="text-center"
                  [ngClass]="{
                    'text-danger font-weight-bold': item.state == 'Inactivo'
                  }"
                >
                  <td class="align-middle pb-0">
                    <mat-checkbox
                      color="primary"
                      (change)="guardarPresupuesto($event, item)"
                      [id]="item.id"
                      >PRES {{ item.id }}</mat-checkbox
                    >
                  </td>
                  <td class="align-middle">
                    {{ item.created_at | date : "longDate" }}
                  </td>
                  <td class="align-middle">{{ item.customer.name }}</td>
                  <td class="align-middle">{{ item.destiny.name }}</td>
                  <td class="align-middle">{{ item.line }}</td>
                  <td class="align-middle">
                    {{ item.user.person.first_name }}
                    {{ item.user.person.first_surname }}
                  </td>
                  <td class="align-middle">
                    ${{ item.total_cop | currency : "" : "" }}
                  </td>
                  <td class="align-middle">
                    ${{ item.total_usd | currency : "" : "" }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ngb-pagination
            class="d-flex justify-content-center pagination-rounded pagination-sm"
            [collectionSize]="paginationBudgets.collectionSize"
            [pageSize]="paginationBudgets.pageSize"
            [(page)]="paginationBudgets.page"
            (pageChange)="getBudgets($event)"
            maxSize="5"
            rotate="true"
            ellipses="false"
            boundaryLinks="true"
          >
          </ngb-pagination>
        </ng-container>
      </div>
      <div class="mt-3">
        <div class="row">
          <div class="col-md mb-3">
            <h6>Cotizaciones disponibles</h6>
          </div>
          <div class="col-md mb-3 text-right">
            <div class="btn-group rounded w-sm-100">
              <button
                class="btn btn-primary btn-sm"
                (click)="_modal.close()"
                [routerLink]="['/crm/cotizacion/crear']"
              >
                <i class="fa fa-plus"></i> Agregar
              </button>
            </div>
          </div>
        </div>
        <ng-container *ngIf="quotations.length > 0; else notDataAd">
          <div class="rounded-top table-responsive">
            <table
              class="table table-bordered table-striped table-sm mt-2"
              style="font-size: smaller"
            >
              <thead class="bg-light">
                <tr class="text-center text-uppercase">
                  <th>Item</th>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Linea</th>
                  <th>Total COP</th>
                  <th>Total USD</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of quotations" class="text-center">
                  <td class="align-middle pb-0">
                    <mat-checkbox
                      color="primary"
                      (change)="guardarCotizacion($event, item)"
                      [id]="item.id"
                      >COT {{ item.id }}</mat-checkbox
                    >
                  </td>
                  <td class="align-middle">
                    {{ item.created_at | date : "longDate" }}
                  </td>
                  <td class="align-middle">{{ item.client.full_name }}</td>
                  <td class="align-middle">{{ item.line }}</td>
                  <td class="align-middle">
                    ${{ item.total_cop | currency : "" : "" }}
                  </td>
                  <td class="align-middle">
                    ${{ item.total_usd | currency : "" : "" }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ngb-pagination
            class="d-flex justify-content-center pagination-rounded pagination-sm"
            [collectionSize]="paginationQuotations.collectionSize"
            [pageSize]="paginationQuotations.pageSize"
            [(page)]="paginationQuotations.page"
            (pageChange)="getQuotations($event)"
            maxSize="5"
            rotate="true"
            ellipses="false"
            boundaryLinks="true"
          >
          </ngb-pagination>
        </ng-container>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-danger"
      (click)="modal.dismiss('Cross click')"
    >
      Cancelar
    </button>
    <button type="submit" (click)="saveBusiness()" class="btn btn-primary">
      Guardar
    </button>
  </div>
</ng-template>


<ng-template #notDataAd>
  <div class="alert alert-warning" role="alert">
    {{
      form.controls.third_party_id.valid &&
      (quotations.length || budgets.length)
        ? "No hemos encontrado información para este cliente"
        : "Selecciona un cliente para listar la información"
    }}
  </div>
</ng-template>
