<div class="card">
  <div class="card-body">
    <div class="row card-title d-flex justify-content-between">
      <div class="col-md-6 px-0">
        <h4 class="text-primary">Panel de negocios</h4>
      </div>
      <div class="col-md-6 px-0 text-right">
        <div class="btn-group rounded w-sm-100">
          <button class="btn btn-primary btn-sm" (click)="openConfirm(add)">
            <i class="fa fa-plus"></i> Agregar
          </button>
          <button class="btn btn-info btn-sm" (click)="openClose()">
            <i class="fas fa-sliders-h"></i> Filtros
          </button>
        </div>
      </div>
    </div>
    <hr class="line" />
    <mat-accordion multi>
      <mat-expansion-panel class="mat-elevation-z0">
        <form [formGroup]="formFiltersBusiness">
          <div class="row">
            <mat-form-field class="col" appearance="outline">
              <mat-label>Código</mat-label>
              <input
                type="text"
                matInput
                formControlName="code"
                autocomplete="off"
                placeholder="Busca por código"
              />
            </mat-form-field>
            <mat-form-field class="col" appearance="outline">
              <mat-label>Nombre</mat-label>
              <input
                type="text"
                matInput
                formControlName="name"
                autocomplete="off"
                placeholder="Busca por nombre"
              />
            </mat-form-field>
            <mat-form-field class="col" appearance="outline">
              <mat-label>Empresa</mat-label>
              <input
                type="text"
                matInput
                formControlName="company_name"
                autocomplete="off"
                placeholder="Busca por empresa"
              />
            </mat-form-field>
          </div>
        </form>
      </mat-expansion-panel>
    </mat-accordion>
    <ul
      ngbNav
      #nav="ngbNav"
      [(activeId)]="active"
      class="nav nav-tabs justify-content-center mb-0"
    >
      <li [ngbNavItem]="1">
        <a
          ngbNavLink
          (click)="getNegocios(); changeUrl('?active=1')"
          data-toggle="tab"
          role="tab"
          aria-controls="home"
          aria-selected="true"
          class="nav-link border-0 text-uppercase font-weight-bold"
        >
          Tabla de negocios
        </a>
        <ng-template ngbNavContent>
          <app-table-negocios
            [negocios]="business"
            [pagination]="paginationBusiness"
            (getNegocios)="getNegocios($event)"
            [loading]="loading"
          ></app-table-negocios>
        </ng-template>
      </li>
      <li [ngbNavItem]="2">
        <a
          ngbNavLink
          (click)="getNegocios(); changeUrl('?active=2')"
          data-toggle="tab"
          role="tab"
          aria-controls="home"
          aria-selected="true"
          class="nav-link border-0 text-uppercase font-weight-bold"
        >
          Etapas
        </a>
        <ng-template ngbNavContent>
          <div
            class="row mt-3"
            *ngIf="!loading2 && business.length > 0; else notData"
          >
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body border-bottom">
                  <h4 class="card-title text-center">Etapa 1</h4>
                  <div class="d-flex justify-content-between mb-3">
                    <span>{{ negocios_primera_etapa.length }} Negocio(s)</span>
                    <span>$ {{ total.first | number }}</span>
                  </div>
                  <div
                    id="Todo-task"
                    class="task-list"
                    dndDropzone
                    dndEffectAllowed="move"
                    (dndDrop)="onDrop($event, negocios_primera_etapa, 'first')"
                  >
                    <ng-container *ngFor="let task of negocios_primera_etapa">
                      <div
                        [dndDraggable]="task"
                        dndEffectAllowed="move"
                        (dndMoved)="onDragged(task, negocios_primera_etapa)"
                      >
                        <ng-template
                          [ngTemplateOutlet]="NegocioContent"
                          [ngTemplateOutletContext]="{ neg: task }"
                        >
                        </ng-template>
                      </div>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body border-bottom">
                  <h4 class="card-title text-center">Etapa 2</h4>
                  <div class="d-flex justify-content-between mb-3">
                    <span>{{ negocios_segunda_etapa.length }} Negocio(s)</span>
                    <span>$ {{ total.second | number }}</span>
                  </div>
                  <div
                    id="Progress-task"
                    class="task-list"
                    dndDropzone
                    dndEffectAllowed="move"
                    (dndDrop)="onDrop($event, negocios_segunda_etapa, 'second')"
                  >
                    <ng-container *ngFor="let task of negocios_segunda_etapa">
                      <div
                        [dndDraggable]="task"
                        dndEffectAllowed="move"
                        (dndMoved)="onDragged(task, negocios_segunda_etapa)"
                      >
                        <ng-template
                          [ngTemplateOutlet]="NegocioContent"
                          [ngTemplateOutletContext]="{ neg: task }"
                        >
                        </ng-template>
                      </div>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body border-bottom">
                  <h4 class="card-title text-center">Etapa 3</h4>
                  <div class="d-flex justify-content-between mb-3">
                    <span>{{ negocios_tercera_etapa.length }} Negocio(s)</span>
                    <span>$ {{ total.third | number }}</span>
                  </div>
                  <div
                    id="Progress-task"
                    class="task-list"
                    dndDropzone
                    dndEffectAllowed="move"
                    (dndDrop)="onDrop($event, negocios_tercera_etapa, 'third')"
                  >
                    <ng-container *ngFor="let neg of negocios_tercera_etapa">
                      <div
                        [dndDraggable]="neg"
                        dndEffectAllowed="move"
                        (dndMoved)="onDragged(neg, negocios_tercera_etapa)"
                      >
                        <ng-template
                          [ngTemplateOutlet]="NegocioContent"
                          [ngTemplateOutletContext]="{ neg: neg }"
                        >
                        </ng-template>
                      </div>
                    </ng-container>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </li>
    </ul>
    <div [ngbNavOutlet]="nav" class="mt-2"></div>
  </div>
</div>

<ng-template #NegocioContent let-neg="neg">
  <div class="card task-box">
    <div class="card-body" style="cursor: move">
      <div class="progress progress-sm animated-progess" style="height: 3px">
        <div
          class="progress-bar"
          role="progressbar"
          style="width: 72%"
          aria-valuenow="72"
          aria-valuemin="0"
          aria-valuemax="100"
        ></div>
      </div>
      <div class="d-flex justify-content-between my-2">
        <a [routerLink]="['/crm/negocios/', neg.id]" class="">{{ neg.code }}</a>
        <span>{{ neg.date | date : "mediumDate" }}</span>
      </div>
      <div>
        <h5 class="font-size-16">
          <a class="text-dark">{{
            neg.third_party.first_name
              ? neg.third_party.first_name + " " + neg.third_party.first_surname
              : neg.third_party.social_reason
          }}</a>
        </h5>
        <span class="mb-4">{{ neg.name }}</span>
      </div>

      <div class="d-inline-flex team mb-0">
        <div class="mr-3 align-self-center">
          Presupuesto :
          <span class="mb-4">{{ neg.budget_value | number }}</span>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #add let-modal>
  <div class="modal-header">
    <h4 class="text-primary modal-title">Nuevo negocio</h4>
    <button
      type="button"
      class="close"
      data-dismiss="modal"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    >
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="modal-body">
    <form [formGroup]="form">
      <div class="row">
        <mat-form-field class="col" appearance="outline">
          <mat-label>Nombre de la solicitud</mat-label>
          <input
            matInput
            id="request_name"
            type="text"
            placeholder="Ingresa el nombre"
            formControlName="name"
            name="solicitud"
            autocomplete="off"
            required
          />
        </mat-form-field>
        <mat-form-field class="col" appearance="outline">
          <mat-label>Fecha de entrega</mat-label>
          <input
            matInput
            id="date"
            type="date"
            [min]="today"
            formControlName="date"
            name="plazo"
            required
            autocomplete="off"
          />
        </mat-form-field>
        <div class="col mb-4">
          <ng-select
            [items]="companies"
            formControlName="third_party_id"
            placeholder="Compañía *"
            [appendTo]="'body'"
            appearance="outline"
            (change)="getContacts(); getBudgets(); getQuotations()"
            bindValue="value"
            bindLabel="text"
            required
          >
          </ng-select>
        </div>
        <div class="col mb-4">
          <ng-select
            [items]="contacts"
            formControlName="third_party_person_id"
            placeholder="Contacto *"
            bindLabel="text"
            [appendTo]="'body'"
            appearance="outline"
            bindValue="value"
            notFoundText="No hay registros"
          >
          </ng-select>
        </div>
        <div class="col mb-4">
          <ng-select
            [items]="countries"
            formControlName="country_id"
            placeholder="País *"
            (change)="filterDepartments($event.value)"
            bindLabel="text"
            [appendTo]="'body'"
            appearance="outline"
            bindValue="value"
            ngDefaultControl
            notFoundText="No hay registros"
          >
          </ng-select>
        </div>
        <div class="col mb-4">
          <ng-select
            [items]="cities"
            formControlName="city_id"
            bindLabel="text"
            bindValue="value"
            ngDefaultControl
            [appendTo]="'body'"
            appearance="outline"
            placeholder="Ciudad *"
            notFoundText="No hay registros"
          >
          </ng-select>
        </div>
        <mat-form-field
          class="col-md-12 mat-form-field-no-padding textarea"
          appearance="outline"
        >
          <mat-label>Descripción</mat-label>
          <textarea
            matInput
            placeholder="Ingrese la descripción"
            rows="5"
            formControlName="description"
            id="descripcion"
            name="description"
            required
            [cdkTextareaAutosize]="true"
          ></textarea>
        </mat-form-field>
      </div>
      <div class="mt-3">
        <h6>Presupuestos disponibles</h6>
        <ng-container *ngIf="budgets.length > 0; else notDataAd">
          <div class="rounded-top table-responsive">
            <table
              class="table table-bordered table-striped table-sm mt-2"
              style="font-size: smaller"
            >
              <thead class="bg-light">
                <tr class="text-center text-uppercase">
                  <th>Item</th>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Destino</th>
                  <th>Linea</th>
                  <th>Quien elabora</th>
                  <th>Total COP</th>
                  <th>Total USD</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  *ngFor="let item of budgets"
                  class="text-center"
                  [ngClass]="{
                    'text-danger font-weight-bold': item.state == 'Inactivo'
                  }"
                >
                  <td class="align-middle pb-0">
                    <mat-checkbox
                      color="primary"
                      (change)="guardarPresupuesto($event, item)"
                      [id]="item.id"
                      >PRES {{ item.id }}</mat-checkbox
                    >
                    <!-- <input
                      type="checkbox"
                      (change)="guardarPresupuesto($event, item)"
                      [id]="item.id"
                    />
                    <span class="ml-1"></span> -->
                  </td>
                  <td class="align-middle">
                    {{ item.created_at | date : "longDate" }}
                  </td>
                  <td class="align-middle">{{ item.customer.name }}</td>
                  <td class="align-middle">{{ item.destiny.name }}</td>
                  <td class="align-middle">{{ item.line }}</td>
                  <td class="align-middle">
                    {{ item.user.person.first_name }}
                    {{ item.user.person.first_surname }}
                  </td>
                  <td class="align-middle">
                    ${{ item.total_cop | currency : "" : "" }}
                  </td>
                  <td class="align-middle">
                    ${{ item.total_usd | currency : "" : "" }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ngb-pagination
            class="d-flex justify-content-center pagination-rounded pagination-sm"
            [collectionSize]="paginationBudgets.collectionSize"
            [pageSize]="paginationBudgets.pageSize"
            [(page)]="paginationBudgets.page"
            (pageChange)="getBudgets($event)"
            maxSize="5"
            rotate="true"
            ellipses="false"
            boundaryLinks="true"
          >
          </ngb-pagination>
        </ng-container>
      </div>
      <div class="mt-3">
        <h6>Cotizaciones disponibles</h6>
        <ng-container *ngIf="quotations.length > 0; else notDataAd">
          <div class="rounded-top table-responsive">
            <table
              class="table table-bordered table-striped table-sm mt-2"
              style="font-size: smaller"
            >
              <thead class="bg-light">
                <tr class="text-center text-uppercase">
                  <th>Item</th>
                  <th>Fecha</th>
                  <th>Cliente</th>
                  <th>Linea</th>
                  <th>Total COP</th>
                  <th>Total USD</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let item of quotations" class="text-center">
                  <td class="align-middle pb-0">
                    <mat-checkbox
                      color="primary"
                      (change)="guardarCotizacion($event, item)"
                      [id]="item.id"
                      >COT {{ item.id }}</mat-checkbox
                    >
                  </td>
                  <td class="align-middle">
                    {{ item.created_at | date : "longDate" }}
                  </td>
                  <td class="align-middle">{{ item.client.full_name }}</td>
                  <td class="align-middle">{{ item.line }}</td>
                  <td class="align-middle">
                    ${{ item.total_cop | currency : "" : "" }}
                  </td>
                  <td class="align-middle">
                    ${{ item.total_usd | currency : "" : "" }}
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
          <ngb-pagination
            class="d-flex justify-content-center pagination-rounded pagination-sm"
            [collectionSize]="paginationQuotations.collectionSize"
            [pageSize]="paginationQuotations.pageSize"
            [(page)]="paginationQuotations.page"
            (pageChange)="getQuotations($event)"
            maxSize="5"
            rotate="true"
            ellipses="false"
            boundaryLinks="true"
          >
          </ngb-pagination>
        </ng-container>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-danger"
      (click)="modal.dismiss('Cross click')"
    >
      Cancelar
    </button>
    <button type="submit" (click)="saveBusiness()" class="btn btn-primary">
      Guardar
    </button>
  </div>
</ng-template>
<ng-template #notData>
  <app-not-data [loading]="loading2"></app-not-data>
</ng-template>
<ng-template #notDataAd>
  <div class="alert alert-warning" role="alert">
    {{
      form.controls.third_party_id.valid &&
      (quotations.length || budgets.length)
        ? "No hemos encontrado información para este cliente"
        : "Selecciona un cliente para listar la información"
    }}
  </div>
</ng-template>

<!-- <ng-template ng-label-tmp let-item="item">
  <span>{{
    item.first_name
      ? item.first_name + " " + item.first_surname
      : item.social_reason
  }}</span>
</ng-template>
<ng-template
  ng-option-tmp
  let-item="item"
  let-search="searchTerm"
  let-index="index"
>
  <span>{{
    item.first_name
      ? item.first_name + " " + item.first_surname
      : item.social_reason
  }}</span>
</ng-template>
 -->
