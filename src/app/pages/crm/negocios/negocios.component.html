<div class="card">
  <div class="card-body">
    <div class="row card-title d-flex justify-content-between">
      <div class="col-md-6 px-0">
        <h4 class="text-primary">Panel de negocios</h4>
      </div>
      <div class="col-md-6 px-0 text-right">
        <div class="btn-group rounded w-sm-100">
          <button class="btn btn-primary btn-sm" (click)="openConfirm(add)">
            <i class="fa fa-plus"></i> Agregar
          </button>
        </div>
      </div>
    </div>
    <ul
      ngbNav
      #nav="ngbNav"
      [(activeId)]="active"
      class="nav nav-pills nav-justified border border-primary rounded"
    >
      <li [ngbNavItem]="1">
        <a ngbNavLink (click)="getNegocios()" class="h-100">
          <i class="fa fa-list"></i> Tabla de negocios
        </a>
        <ng-template ngbNavContent>
          <app-table-negocios
            [negocios]="negocios"
            [loading]="loading"
          ></app-table-negocios>
        </ng-template>
      </li>
      <li [ngbNavItem]="2">
        <a ngbNavLink (click)="getNegocios()" class="h-100">
          <i class="fa fa-th"></i> Etapas
        </a>
        <ng-template ngbNavContent>
          <div class="row mt-3">
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body border-bottom">
                  <h4 class="card-title text-center">Etapa 1</h4>
                  <div class="d-flex justify-content-between mb-3">
                    <span>{{ negocios_primera_etapa.length }} Negocio(s)</span>
                    <span>$ {{ total.first | number }}</span>
                  </div>
                  <div
                    id="Todo-task"
                    class="task-list"
                    dndDropzone
                    dndEffectAllowed="move"
                    (dndDrop)="onDrop($event, negocios_primera_etapa, 'first')"
                  >
                    <ng-container *ngFor="let task of negocios_primera_etapa">
                      <div
                        [dndDraggable]="task"
                        dndEffectAllowed="move"
                        (dndMoved)="onDragged(task, negocios_primera_etapa)"
                      >
                        <ng-template
                          [ngTemplateOutlet]="NegocioContent"
                          [ngTemplateOutletContext]="{ neg: task }"
                        >
                        </ng-template>
                      </div>
                    </ng-container>
                    <!-- end task card -->
                  </div>
                </div>
              </div>
            </div>

            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body border-bottom">
                  <h4 class="card-title text-center">Etapa 2</h4>
                  <div class="d-flex justify-content-between mb-3">
                    <span>{{ negocios_segunda_etapa.length }} Negocio(s)</span>
                    <span>$ {{ total.second | number }}</span>
                  </div>
                  <div
                    id="Progress-task"
                    class="task-list"
                    dndDropzone
                    dndEffectAllowed="move"
                    (dndDrop)="onDrop($event, negocios_segunda_etapa, 'second')"
                  >
                    <ng-container *ngFor="let task of negocios_segunda_etapa">
                      <div
                        [dndDraggable]="task"
                        dndEffectAllowed="move"
                        (dndMoved)="onDragged(task, negocios_segunda_etapa)"
                      >
                        <ng-template
                          [ngTemplateOutlet]="NegocioContent"
                          [ngTemplateOutletContext]="{ neg: task }"
                        >
                        </ng-template>
                      </div>
                    </ng-container>
                    <!-- end task card -->
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="card bg-light">
                <div class="card-body border-bottom">
                  <h4 class="card-title text-center">Etapa 3</h4>
                  <div class="d-flex justify-content-between mb-3">
                    <span>{{ negocios_tercera_etapa.length }} Negocio(s)</span>
                    <span>$ {{ total.third | number }}</span>
                  </div>
                  <div
                    id="Progress-task"
                    class="task-list"
                    dndDropzone
                    dndEffectAllowed="move"
                    (dndDrop)="onDrop($event, negocios_tercera_etapa, 'third')"
                  >
                    <ng-container *ngFor="let neg of negocios_tercera_etapa">
                      <div
                        [dndDraggable]="neg"
                        dndEffectAllowed="move"
                        (dndMoved)="onDragged(neg, negocios_tercera_etapa)"
                      >
                        <ng-template
                          [ngTemplateOutlet]="NegocioContent"
                          [ngTemplateOutletContext]="{ neg: neg }"
                        >
                        </ng-template>
                      </div>
                    </ng-container>
                    <!-- end task card -->
                  </div>
                </div>
              </div>
            </div>
          </div>
        </ng-template>
      </li>
    </ul>
    <div [ngbNavOutlet]="nav" class="mt-2"></div>
  </div>
</div>

<ng-template #NegocioContent let-neg="neg">
  <div class="card task-box">
    <div class="card-body" style="cursor: move">
      <div class="progress progress-sm animated-progess" style="height: 3px">
        <div
          class="progress-bar"
          role="progressbar"
          style="width: 72%"
          aria-valuenow="72"
          aria-valuemin="0"
          aria-valuemax="100"
        ></div>
      </div>
      <div class="d-flex justify-content-between my-2">
        <a [routerLink]="['/crm/negocios/', neg.id]" class="">{{ neg.code }}</a>
        <span>{{ neg.date | date: "mediumDate" }}</span>
      </div>
      <div>
        <h5 class="font-size-16">
          <a class="text-dark">{{
            neg.third_party.first_name
              ? neg.third_party.first_name + " " + neg.third_party.first_surname
              : neg.third_party.social_reason
          }}</a>
        </h5>
        <span class="mb-4">{{ neg.name }}</span>
      </div>

      <div class="d-inline-flex team mb-0">
        <div class="mr-3 align-self-center">
          Presupuesto :
          <span class="mb-4">{{ neg.budget_value | number }}</span>
        </div>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #add let-modal>
  <div class="modal-header">
    <h4 class="text-primary modal-title">Nuevo negocio</h4>
    <button
      type="button"
      class="btn btn-sm btn-flash-border-primary ri-close-fill"
      aria-label="Close"
      (click)="modal.dismiss('Cross click')"
    ></button>
  </div>
  <div class="modal-body">
    <form [formGroup]="form">
      <div class="row">
        <mat-form-field class="col-md-4" appearance="outline">
          <mat-label>Nombre de la solicitud</mat-label>
          <input
            matInput
            id="request_name"
            type="text"
            placeholder="Ingresa el nombre"
            formControlName="name"
            name="solicitud"
            autocomplete="off"
            required
          />
        </mat-form-field>
        <mat-form-field class="col-md-4" appearance="outline">
          <mat-label>Fecha de entrega</mat-label>
          <input
            matInput
            id="date"
            type="date"
            [min]="today"
            formControlName="date"
            name="plazo"
            required=""
            autocomplete="off"
          />
        </mat-form-field>
        <mat-form-field class="col-md-4" appearance="outline">
          <mat-label>Cotizacion</mat-label>
          <mat-select
            name="cotizaciones"
            formControlName="cotizacion_id"
            id="cotizacion"
          >
            <mat-option value="null">cotizacion...</mat-option>
            <mat-option value="coti">cotizacion</mat-option>
          </mat-select>
        </mat-form-field>
        <mat-form-field
          class="col-md-12 mat-form-field-no-padding"
          appearance="outline"
        >
          <mat-label>Descripción</mat-label>
          <textarea
            matInput
            placeholder="Ingrese la descripción"
            rows="5"
            formControlName="description"
            id="descripcion"
            name="description"
            required
            [cdkTextareaAutosize]="true"
          ></textarea>
        </mat-form-field>

        <div class="col-md-3 mb-4">
          <ng-select
            [items]="companies"
            formControlName="third_party_id"
            placeholder="Compañía"
            [appendTo]="'body'"
            appearance="outline"
            (change)="getContacts(); getBudgets()"
            bindValue="id"
            notFoundText="No hay registros"
            required
          >
            <ng-template ng-label-tmp let-item="item">
              <span>{{
                item.first_name
                  ? item.first_name + " " + item.first_surname
                  : item.social_reason
              }}</span>
            </ng-template>
            <ng-template
              ng-option-tmp
              let-item="item"
              let-search="searchTerm"
              let-index="index"
            >
              <span>{{
                item.first_name
                  ? item.first_name + " " + item.first_surname
                  : item.social_reason
              }}</span>
            </ng-template>
          </ng-select>
        </div>
        <div class="col-md-3 mb-4">
          <!-- <div *ngIf="contacts"> -->
          <ng-select
            [items]="contacts"
            formControlName="third_party_person_id"
            placeholder="Contacto"
            bindLabel="name"
            [appendTo]="'body'"
            appearance="outline"
            bindValue="id"
            notFoundText="No hay registros"
          >
          </ng-select>
        </div>
        <div class="col-md-3 mb-4">
          <ng-select
            [items]="countries"
            formControlName="country_id"
            placeholder="País"
            (change)="getCities()"
            bindLabel="text"
            [appendTo]="'body'"
            appearance="outline"
            bindValue="value"
            ngDefaultControl
            notFoundText="No hay registros"
          >
          </ng-select>
        </div>
        <div class="col-md-3 mb-4">
          <ng-select
            [items]="cities"
            formControlName="city_id"
            bindLabel="name"
            bindValue="id"
            ngDefaultControl
            [appendTo]="'body'"
            appearance="outline"
            placeholder="Ciudad"
            notFoundText="No hay registros"
          >
          </ng-select>
        </div>
      </div>
      <div class="mt-3" *ngIf="budgets.length > 0">
        <h6 class="text-center">Presupuestos disponibles</h6>
        <div class="rounded-top table-responsive">
          <table
            class="table table-bordered table-striped table-sm mt-2"
            style="font-size: smaller"
          >
            <thead class="bg-light">
              <tr class="text-center text-uppercase">
                <th>Item</th>
                <th>Fecha</th>
                <th>Cliente</th>
                <th>Destino</th>
                <th>Linea</th>
                <th>Quien elabora</th>
                <th>Total COP</th>
                <th>Total USD</th>
              </tr>
            </thead>
            <tbody>
              <tr
                *ngFor="let item of budgets"
                class="text-center"
                [ngClass]="{
                  'text-danger font-weight-bold': item.state == 'Inactivo'
                }"
              >
                <td class="align-middle">
                  <input
                    type="checkbox"
                    (change)="guardarPresupuesto($event, item)"
                    [id]="item.id"
                  />
                  <span class="ml-1">PRES {{ item.id }}</span>
                </td>
                <td class="align-middle">
                  {{ item.created_at | date: "longDate" }}
                </td>
                <td class="align-middle">{{ item.customer.name }}</td>
                <td class="align-middle">{{ item.destiny.name }}</td>
                <td class="align-middle">{{ item.line }}</td>
                <td class="align-middle">
                  {{ item.user.person.first_name }}
                  {{ item.user.person.first_surname }}
                </td>
                <td class="align-middle">
                  ${{ item.total_cop | currency: "":"" }}
                </td>
                <td class="align-middle">
                  ${{ item.total_usd | currency: "":"" }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </form>
  </div>
  <div class="modal-footer">
    <button
      type="button"
      class="btn btn-default"
      (click)="modal.dismiss('Cross click')"
    >
      Cancelar
    </button>
    <button
      type="submit"
      (click)="createNeg()"
      class="btn btn-primary"
      [disabled]="!form.valid"
    >
      Guardar
    </button>
  </div>
</ng-template>
