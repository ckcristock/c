<ng-container [formGroup]="forma">


    <div class="row " formArrayName="items">
        <div class="col-12 text-center m-4">
            <h4>Elementos del presupuesto</h4>
        </div>
        <ng-container *ngIf="items.controls.length ; else notData">

            <div class="card " style="width:100% ;" *ngFor="let item of items.controls; let i = index">
                <div class="card-header header-item w-100">
                    <div class=" d-flex align-items-center justify-content-between">
                        <span class="bg-info p-2 text-white">{{ i + 1 }}</span>
                        <span class="text-center"> <strong>ITEM {{ i + 1 }} </strong></span>
                        <span class="text-center">
                            <i ngbTooltip="Eliminar Item" (click)="deleteItem(i)"
                                class="text-danger fas fa-times bg-white"></i>
                        </span>
                    </div>
                </div>
                <div style="overflow-x:auto;" class="items table-responsive" class="card-body ">

                    <table [formGroupName]="i" width="100%" cellspacing="0"
                        class="table table-striped table-sm table-items">
                        <thead>

                            <tr>
                                <th colspan="7">Costos Directos</th>
                                <th [DynamicColspan]="'indirect_cost'" min="1" [max]="(indirectCosts.length + 1)"
                                    class="detachable" (click)="changeView(item,'indirect_cost')">
                                    <ng-container *ngIf="item.controls.shows.value.indirect_cost ; else down">
                                        <i class=" fas fa-chevron-right text-primary"></i>
                                    </ng-container>
                                    Cost. Indirectos
                                </th>
                                <th DynamicColspan min="1" [max]="(7)" class="detachable"
                                    (click)="changeView(item,'sum_others')">
                                    <ng-container *ngIf="item.controls.shows.value.sum_others ; else down">
                                        <i class=" fas fa-chevron-right text-primary"></i>
                                    </ng-container>
                                    ADM + IMP + UTI
                                </th>
                                <th DynamicColspan min="4" (click)="changeView(item,'total_sale')" [max]="6"
                                    class="detachable">
                                    <ng-container *ngIf="item.controls.shows.value.total_sale ; else down">
                                        <i class=" fas fa-chevron-right text-primary"></i>
                                    </ng-container>
                                    Valor Venta
                                </th>
                                <th (click)="changeView(item,'prorrateo')" class="detachable"
                                    *ngIf="item.controls.shows.value.prorrateo" colspan="4">
                                    <ng-container *ngIf="item.controls.shows.value.prorrateo ; else down">
                                        <i class=" fas fa-chevron-right text-primary"></i>
                                    </ng-container>
                                    Prorrateo de Valores
                                </th>
                                <th></th>

                                <th></th>
                            </tr>
                            <tr>
                                <th>#</th>
                                <th>Tipo</th>
                                <th>Descripción</th>
                                <th>Unidad</th>
                                <th>Cantidad</th>
                                <th>C. Unitario</th>
                                <th title="Valor Total Costo">VT. Costo</th>
                                <ng-container *ngIf="item.controls.shows.value.indirect_cost">
                                    <th *ngFor="let item of indirectCosts">
                                        {{item.text}}
                                    </th>

                                </ng-container>

                                <th title="Subtotal Indirectos">SubT. Indirectos</th>

                                <ng-container *ngIf="item.controls.shows.value.sum_others">
                                    <th>%</th>
                                    <th>AMD</th>
                                    <th>%</th>
                                    <th>Imprevistos</th>
                                    <th>%</th>
                                    <th>Utilidad</th>
                                </ng-container>

                                <th>ADM+IMP+UTI</th>
                                <th>Otros Cargos</th>
                                <ng-container *ngIf="item.controls.shows.value.total_sale">
                                    <th>Subtotal</th>
                                    <th>Retención</th>
                                </ng-container>
                                <th>%</th>
                                <th>V/U Venta COP</th>
                                <th>V/U Venta USD</th>
                                <ng-container *ngIf="item.controls.shows.value.prorrateo">
                                    <th>V. Prorr. COP</th>
                                    <th>V. Prorr. USD</th>
                                    <th>V/U Venta Prorr. COP</th>
                                    <th>V/U Venta Prorr. USD</th>
                                </ng-container>

                                <th>Observ.</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody>
                            <ng-container *ngIf="item.controls.subItems.controls.length ; else notData2">
                                <ng-container formArrayName="subItems">

                                    <ng-container [formGroupName]="y"
                                        *ngFor="let subItem of item.controls.subItems.controls; let y = index;">
                                        <tr>
                                            <td> {{i + 1 }}.{{y+1}}</td>
                                            <td>
                                                <select formControlName="type" *ngIf="!subItem.controls.type_module.value;else type"
                                                 
                                                    style="width: 50px;" class="form-control form-control-sm">
                                                    <option [value]="type.value" *ngFor="let type of types">
                                                        {{ type.name }}
                                                    </option>
                                                </select>
                                                <ng-template #type> {{subItem.controls.type.value}} </ng-template>
                                                
                                            </td>
                                            <td>
                                                <!--  <input type="text" style="width:280px" formControlName="description"
                                                    class="form-control form-control-sm" /> -->
                                                <!--  <input id="typeahead-focus" type="text" class="form-control"
                                                    [(ngModel)]="model" [ngbTypeahead]="search"
                                                    (focus)="focus$.next($any($event).target.value)"
                                                    (click)="click$.next($any($event).target.value)"
                                                    #instance="ngbTypeahead" /> -->

                                                <div style="position: relative;">
                                                    <!-- [class.is-invalid]="(subItem.get('apu_id').invalid && subItem.get('description').touched)" -->

                                                    <input style="width:280px" id="typeahead-http" type="text"
                                                        class="form-control form-control-sm"
                                                        [readonly]="subItem.get('type_module').value"
                                                        [ngClass]="{'form-control-plaintext': subItem.get('type_module').value}"
                                                        formControlName="description" />



                                                </div>
                                                <!--  <small *ngIf="searching"
                                                    class="form-text text-muted">searching...</small> -->



                                            </td>
                                            <td>
                                                <input type="text" style="width:70px"
                                                    class="form-control form-control-sm" />
                                            </td>
                                            <td>
                                                <input type="number" style="width:80px" formControlName="cuantity"
                                                    class="form-control form-control-sm" />
                                            </td>
                                            <td>
                                                <input type="number" style="width:90px" formControlName="unit_cost"
                                                    class="form-control form-control-sm" />
                                            </td>
                                            <td>
                                                <div class="values" style="width:90px">{{
                                                    subItem.controls.total_cost.value
                                                    | currency:'':''
                                                    }}</div>
                                            </td>

                                            <!-- Costos directos -->
                                            <ng-container formArrayName="indirect_costs"
                                                *ngIf="item.controls.shows.value.indirect_cost">
                                                <ng-container [formGroupName]="indirecIndex"
                                                    *ngFor="let indirect of  subItem.controls.indirect_costs.controls ; let indirecIndex = index">
                                                    <td>
                                                        <div class="values" style="width:90px">
                                                            {{ indirect.controls.value.value | currency:'':''}}</div>
                                                    </td>
                                                </ng-container>

                                            </ng-container>
                                            <td>
                                                <div class="values" style="width:90px">{{
                                                    subItem.controls.subtotal_indirect_cost.value |
                                                    currency:'':'' }}
                                                </div>
                                            </td>
                                            <!-- end Costos directos -->


                                            <!-- Variables AMD IMPREVISTOS UTILIDAD -->
                                            <ng-container *ngIf="item.controls.shows.value.sum_others">

                                                <td><input formControlName="percentage_amd" type="number"
                                                        style="width: 50px;" class="form-control form-control-sm"> </td>
                                                <td>
                                                    <div class="values" style="width:90px">
                                                        {{ subItem.controls.value_amd.value | currency:'':'' }}
                                                    </div>

                                                </td>

                                                <td><input formControlName="percentage_unforeseen" type="number"
                                                        style="width: 50px;" class="form-control form-control-sm">
                                                </td>
                                                <td>
                                                    <div class="values" style="width:90px">
                                                        {{ subItem.controls.value_unforeseen.value | currency:'':'' }}
                                                    </div>
                                                </td>

                                                <td><input formControlName="percentage_utility" type="number"
                                                        style="width: 50px;" class="form-control form-control-sm"> </td>
                                                <td>
                                                    <div class="values" style="width:90px">
                                                        {{ subItem.controls.value_utility.value | currency:'':'' }}
                                                    </div>

                                                </td>

                                            </ng-container>

                                            <td>
                                                <div class="values" style="width:90px">
                                                    {{ subItem.controls.total_amd_imp_uti.value | currency:'':'' }}
                                                </div>

                                            </td>

                                            <!-- END Variables AMD IMPREVISTOS UTILIDAD -->

                                            <!-- Variables TOTAl Venta -->
                                            <td>
                                                <input type="number" formControlName="another_values"
                                                    style="width: 90px;" class="form-control form-control-sm" />
                                            </td>
                                            <ng-container *ngIf="item.controls.shows.value.total_sale">

                                                <td>
                                                    <div class="values" style="width: 90px;">
                                                        {{ subItem.controls.subTotal.value | currency:'':'' }}
                                                    </div>
                                                <td>
                                                    <div class="values" style="width: 90px;">
                                                        {{ subItem.controls.retention.value | currency:'':'' }}
                                                    </div>

                                                </td>

                                            </ng-container>
                                            <td>
                                                <div class="values text-center" style="width: 50px;">
                                                    % {{ subItem.controls.percentage_sale.value }}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="values" style="width: 110px;">
                                                    {{ subItem.controls.value_cop.value | currency:'':'' }}
                                                </div>
                                            </td>
                                            <td>
                                                <div class="values" style="width: 110px;">
                                                    {{ subItem.controls.value_usd.value | currency:'':'' }}
                                                </div>

                                            </td>
                                            <!-- END Variables TOTAl Venta -->
                                            <ng-container *ngIf="item.controls.shows.value.prorrateo">
                                                <td>
                                                    <div class="values" style="width:90px">
                                                        {{ subItem.controls.value_prorrota_cop.value | currency:'':'' }}
                                                    </div>

                                                </td>
                                                <td>
                                                    <div class="values" style="width:90px">

                                                        {{ subItem.controls.value_prorrota_usd.value | currency:'':'' }}
                                                    </div>

                                                </td>
                                                <td>
                                                    <div class="values" style="width:90px">
                                                        {{ subItem.controls.unit_value_prorrateado_cop.value |
                                                        currency:'':'' }}
                                                    </div>

                                                </td>
                                                <td>
                                                    <div class="values" style="width:90px">
                                                        {{ subItem.controls.unit_value_prorrateado_usd.value |
                                                        currency:'':'' }}
                                                    </div>

                                                </td>
                                            </ng-container>
                                            <!-- VARIABLES -->
                                            <td>
                                                <input type="text" style="width: 90px;"
                                                    class="form-control form-control-sm" />
                                            </td>
                                            <td class="text-center">
                                                <div style="width: 50px;">
                                                    <i ngbTooltip="Prorrateo de valores"
                                                        (click)="changeView(item,'prorrateo')"
                                                        class="text-primary  fas fa-hand-holding-usd mr-2"></i>
                                                    <i ngbTooltip="Eliminar Sub Item" (click)="deleteSubItem(item,y)"
                                                        class="text-danger far fa-trash-alt"></i>

                                                </div>
                                            </td>
                                        </tr>
                                    </ng-container>
                                </ng-container>
                                <tr class="bg-gray">
                                    <td colspan="6">SUBTOTAL ITEM {{i + 1}}</td>
                                    <td>
                                        <div class="values">
                                            {{ item.controls.total_cost.value | currency:'':''}}</div>
                                    </td>
                                    <!-- TOTALS COSTOS INDIRECTOS -->
                                    <ng-container formArrayName="subtotal_indirect_cost_dynamic"
                                        *ngIf="item.controls.shows.value.indirect_cost">

                                        <!-- FOREACH indirect COSTS -->
                                        <ng-container [formGroupName]="indirecTotalIndex"
                                            *ngFor="let subtIndirect of  item.controls.subtotal_indirect_cost_dynamic.controls ; let indirecTotalIndex = index">
                                            <td>
                                                <div class="values">
                                                    {{ subtIndirect.controls.sub_total.value | currency:'':''}}</div>
                                            </td>
                                        </ng-container>

                                    </ng-container>
                                    <td>
                                        <div class="values">
                                            {{ item.controls.subtotal_indirect_cost.value | currency:'':''}}</div>
                                    </td>
                                    <!-- END TOTALS COSTOS INDIRECTOS  -->
                                    <!-- OTHERS -->
                                    <ng-container *ngIf="item.controls.shows.value.sum_others">
                                        <td></td>
                                        <td>
                                            <div class="values">
                                                {{ item.controls.value_amd.value | currency:'':''}}</div>
                                        </td>
                                        <td></td>
                                        <td>
                                            <div class="values">
                                                {{ item.controls.value_unforeseen.value | currency:'':''}}</div>
                                        </td>
                                        <td></td>
                                        <td>
                                            <div class="values">
                                                {{ item.controls.value_utility.value | currency:'':''}}</div>
                                        </td>


                                    </ng-container>
                                    <td>
                                        <div class="values">
                                            {{ item.controls.total_amd_imp_uti.value | currency:'':''}}</div>
                                    </td>

                                    <!-- END OTHERS -->
                                    <!-- TOTAL VALOR VENTA -->
                                    <td>
                                        <div class="values">
                                            {{ item.controls.another_values.value | currency:'':''}}</div>
                                    </td>

                                    <ng-container *ngIf="item.controls.shows.value.total_sale">
                                        <td>
                                            <div class="values">
                                                {{ item.controls.subTotal.value | currency:'':''}}</div>
                                        </td>
                                        <td>
                                            <div class="values">
                                                {{ item.controls.retention.value | currency:'':''}}</div>
                                        </td>
                                    </ng-container>
                                    <td>
                                        <div class="values text-center">
                                            % {{ item.controls.percentage_sale.value }}</div>
                                    </td>
                                    <td>
                                        <div class="values">
                                            {{ item.controls.value_cop.value | currency:'':''}}</div>
                                    </td>
                                    <td>
                                        <div class="values">
                                            {{ item.controls.value_usd.value | currency:'':''}}</div>
                                    </td>
                                    <!-- END TOTAL VALOR VENTA -->

                                    <!-- TOTAL PRORRATEO -->
                                    <ng-container *ngIf="item.controls.shows.value.prorrateo">
                                        <td>

                                            <input type="number" style="width:80px" formControlName="value_prorrota_cop"
                                                class="form-control form-control-sm" />
                                        </td>
                                        <td>
                                            <input type="number" style="width:80px" formControlName="value_prorrota_usd"
                                                class="form-control form-control-sm" />

                                        </td>
                                        <td>
                                            <div class="values">
                                                {{ item.controls.unit_value_prorrateado_cop.value | currency:'':''}}
                                            </div>
                                        </td>
                                        <td>
                                            <div class="values">
                                                {{ item.controls.unit_value_prorrateado_usd.value | currency:'':''}}
                                            </div>
                                        </td>
                                    </ng-container>
                                    <!-- TOTAL PRORRATEO -->
                                    <td colspan="2"></td>

                                </tr>
                            </ng-container>

                        </tbody>
                    </table>


                </div>
                <div class="card-footer text-right w-100 bg-white mt-3">

                    <button ngbTooltip="Agregar Sub Item Manual" type="button" (click)="addSubItem(item)"
                        class="btn btn-info btn-sm mr-2">
                        <i class="fas fa-plus"></i>
                    </button>
                    <button ngbTooltip="Agregar Sub Item" type="button" (click)="findApus(item)"
                        class="btn btn-info btn-sm ">
                        <i class="fas fa-search"></i>
                    </button>
                </div>
            </div>
        </ng-container>

        <div class="col-12 mb-4 text-right">

            <button (click)="addItems()" class="btn btn-success btn-sm" type="button" ngbTooltip="Agregar Item">
                <i class="fas fa-plus"></i>
            </button>
        </div>


    </div>

    <ng-template #notData>
        <div class="card col-12">
            <div class="card-body">
                <div class=" p-2  text-center">
                    <h5 class="text-dark">Sin datos agregados</h5>
                </div>
            </div>
        </div>
    </ng-template>

</ng-container>


<ng-template #down>
    <i class="fas fa-chevron-down text-primary"></i>
</ng-template>

<ng-template #notData2>
    <tr class="bg-light">
        <td colspan="100%" class="text-center">
            <p class="text-dark p-1">Sin datos agregados</p>
        </td>
    </tr>
</ng-template>



<ng-template #rt let-r="result" let-t="term">

    <ngb-highlight [result]="r.text" [term]="t"></ngb-highlight>
</ng-template>

<app-get-apus #apus (sendApus)="getApus($event)">

</app-get-apus>