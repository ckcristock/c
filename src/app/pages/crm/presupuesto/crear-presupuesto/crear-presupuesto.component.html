<div class="mb-4">

  <div class="card">
    <div class="card-body">
      <div class="card-title">
        <h4 class="t">PRESUPUESTO DE PROYECTO MAQUINADOS Y MONTAJES</h4>
      </div>
    </div>
  </div>

  <form [formGroup]="forma">
    <div class="card">
      <div class="card-body">
        <!-- HEADER -->
        <div class="row">
          <div class="col-6">
            <div class="form-group row">
              <label for="staticEmail" class="col-sm-2 col-form-label">Cliente</label>
              <div class="col-sm-10">
                <input formControlName="customer_id" type="text" class="form-control" />
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="form-group row">
              <label for="staticEmail" class="col-sm-2 col-form-label">Destino</label>
              <div class="col-sm-10">
                <input formControlName="destinity_id" type="text" class="form-control" />
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="form-group row">
              <label for="staticEmail" class="col-sm-2 col-form-label">Linea</label>
              <div class="col-sm-10">
                <input formControlName="line" type="text" class="form-control" />
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="form-group row">
              <label for="staticEmail" class="col-sm-2 col-form-label">TRM</label>
              <div class="col-sm-10">
                <input formControlName="trm" type="number" class="form-control" />
              </div>
            </div>
          </div>
          <div class="col-6">
            <div class="form-group row">
              <label for="staticEmail" class="col-sm-2 col-form-label">Proyecto</label>
              <div class="col-sm-10">
                <input formControlName="project" type="text" class="form-control" />
              </div>
            </div>
          </div>
        </div>
        <!-- END HEADER -->

        <!-- Configuracion presupuestal -->
        <div class="row mt-2">
          <div class="col-12">
            <table class="table table-striped table-sm">
              <thead>
                <tr>
                  <th class="text-center" colspan="3">
                    <h5>% De configuración presupuestal</h5>
                  </th>
                </tr>
              </thead>
              <tbody class="bg-light">
                <ng-container formArrayName="indirect_costs">
                  <ng-container *ngFor="let item of indirecCostList.controls; let i = index">
                    <tr [formGroupName]="i">
                      <td>{{ item.controls.name.value }}</td>
                      <td>
                        <input type="number" onkeypress="return event.charCode >= 48" min="0"
                          class="form-control form-control-sm" formControlName="percentage" />
                      </td>
                    </tr>
                  </ng-container>
                </ng-container>
              </tbody>
            </table>
          </div>
        </div>
        <!--  END  Configuracion presupuestal -->

        <div class="row mb-2">
          <div class="col-12">
            <div class="form-group">
              <label for="staticEmail">Observaciones</label>
              <textarea formControlName="observation" class="form-control" formControlName="customer_id" cols="100%"
                rows="3"></textarea>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- ITEMS -->

    <div class="row " formArrayName="items">
      <div class="col-12 text-center m-4">
        <h4>Elementos del presupuesto</h4>
      </div>
      <ng-container *ngIf="items.controls.length ; else notData">


        <div class="items" style="overflow-x:auto;" *ngFor="let item of items.controls; let i = index">
          <div class="card">
            <div class="card-body table-responsive">
              <table [formGroupName]="i" width="100%" cellspacing="0" class="table table-striped table-sm table-items">
                <thead>
                  <tr>
                    <th colspan="100%">
                      <div class=" d-flex align-items-center justify-content-between">
                        <span class="bg-info p-2 text-white">{{ i + 1 }}</span>
                        <span class="text-center"> <strong>ITEM {{ i + 1 }} </strong></span>
                        <span class="text-center">
                          <i ngbTooltip="Eliminar Item" (click)="deleteItem(i)" class="text-danger fas fa-times"></i>
                        </span>

                      </div>

                    </th>
                  </tr>
                  <tr>
                    <th colspan="7">Costos Directos</th>
                    <th [DynamicColspan]="'indirect_cost'" min="1" [max]="(indirectCosts.length + 1)" class="detachable"
                      (click)="changeView(item,'indirect_cost')">
                      <ng-container *ngIf="item.controls.shows.value.indirect_cost ; else down">
                        <i class=" fas fa-chevron-right text-primary"></i>
                      </ng-container>
                      Cost. Indirectos
                    </th>
                    <th DynamicColspan min="1" [max]="(7)" class="detachable" (click)="changeView(item,'sum_others')">
                      <ng-container *ngIf="item.controls.shows.value.sum_others ; else down">
                        <i class=" fas fa-chevron-right text-primary"></i>
                      </ng-container>
                      ADM + IMP + UTI
                    </th>
                    <th DynamicColspan min="4" (click)="changeView(item,'total_sale')" [max]="6" class="detachable">
                      <ng-container *ngIf="item.controls.shows.value.total_sale ; else down">
                        <i class=" fas fa-chevron-right text-primary"></i>
                      </ng-container>
                      Valor Venta
                    </th>
                    <th></th>
                    <th></th>
                  </tr>
                  <tr>
                    <th>#</th>
                    <th>Tipo</th>
                    <th>Descripción</th>
                    <th>Unidad</th>
                    <th>Cantidad</th>
                    <th>C. Unitario</th>
                    <th title="Valor Total Costo">VT. Costo</th>
                    <ng-container *ngIf="item.controls.shows.value.indirect_cost">
                      <th *ngFor="let item of indirectCosts">
                        {{item.text}}
                      </th>

                    </ng-container>

                    <th title="Subtotal Indirectos">SubT. Indirectos</th>

                    <ng-container *ngIf="item.controls.shows.value.sum_others">

                      <th>%</th>
                      <th>AMD</th>
                      <th>%</th>
                      <th>Imprevistos</th>
                      <th>%</th>
                      <th>Utilidad</th>
                    </ng-container>

                    <th>ADM+IMP+UTI</th>
                    <th>Otros Cargos</th>
                    <ng-container *ngIf="item.controls.shows.value.total_sale">
                      <th>Subtotal</th>
                      <th>Retención</th>
                    </ng-container>
                    <th>%</th>
                    <th>V/U Venta COP</th>
                    <th>V/U Venta USD</th>
                    <th>Obsserv.</th>
                    <th></th>
                  </tr>
                </thead>
                <tbody formArrayName="subItems">
                  <ng-container *ngIf="item.controls.subItems.controls.length ; else notData2">
                    <ng-container [formGroupName]="y"
                      *ngFor="let subItem of item.controls.subItems.controls; let y = index;">
                      <tr>
                        <td> {{i + 1 }}.{{y+1}}</td>
                        <td>
                          <select formControlName="type" style="width: 50px;" class="form-control form-control-sm">
                            <option [value]="type.value" *ngFor="let type of types">
                              {{ type.name }}
                            </option>
                          </select>
                        </td>
                        <td>
                          <input type="text" style="width:280px" formControlName="description"
                            class="form-control form-control-sm" />
                        </td>
                        <td>
                          <input type="text" style="width:70px" class="form-control form-control-sm" />
                        </td>
                        <td>
                          <input type="number" style="width:80px" formControlName="cuantity"
                            class="form-control form-control-sm" />
                        </td>
                        <td>
                          <input type="number" style="width:90px" formControlName="unit_cost"
                            class="form-control form-control-sm" />
                        </td>
                        <td>
                          <div class="values" style="width:90px">{{ subItem.controls.total_cost.value | currency:'':''
                            }}</div>
                        </td>
                        <ng-container formArrayName="indirect_costs" *ngIf="item.controls.shows.value.indirect_cost">
                          <ng-container [formGroupName]="indirecIndex"
                            *ngFor="let indirect of  subItem.controls.indirect_costs.controls ; let indirecIndex = index">
                            <td>
                              <div class="values" style="width:90px">
                                {{ indirect.controls.value.value | currency:'':''}}</div>
                            </td>
                          </ng-container>

                        </ng-container>
                        <td>
                          <div class="values" style="width:90px">{{ subItem.controls.subtotal_indirect_cost.value |
                            currency:'':'' }}
                          </div>
                        </td>

                        <!-- Variables AMD IMPREVISTOS UTILIDAD -->
                        <ng-container *ngIf="item.controls.shows.value.sum_others">

                          <td><input formControlName="percentage_amd" type="number" style="width: 50px;"
                              class="form-control form-control-sm"> </td>
                          <td>
                            <div class="values" style="width:90px">
                              {{ subItem.controls.value_amd.value | currency:'':'' }}
                            </div>

                          </td>

                          <td><input formControlName="percentage_unforeseen" type="number" style="width: 50px;"
                              class="form-control form-control-sm">
                          </td>
                          <td>
                            <div class="values" style="width:90px">
                              {{ subItem.controls.value_unforeseen.value | currency:'':'' }}
                            </div>
                          </td>

                          <td><input formControlName="percentage_utility" type="number" style="width: 50px;"
                              class="form-control form-control-sm"> </td>
                          <td>
                            <div class="values" style="width:90px">
                              {{ subItem.controls.value_utility.value | currency:'':'' }}
                            </div>

                          </td>

                        </ng-container>

                        <td>
                          <div class="values" style="width:90px">
                            {{ subItem.controls.total_amd_imp_uti.value | currency:'':'' }}
                          </div>
                          <!--  <input type="number" style="width: 90px;" formControlName="total_amd_imp_uti" readonly
                            class="form-control form-control-sm form-control-plaintext" /> -->
                        </td>

                        <!-- END Variables AMD IMPREVISTOS UTILIDAD -->



                        <!-- Variables TOTAl Venta -->
                        <td>
                          <input type="number" formControlName="another_values" style="width: 90px;"
                            class="form-control form-control-sm" />
                        </td>
                        <ng-container *ngIf="item.controls.shows.value.total_sale">

                          <td>
                            <div class="values" style="width: 90px;">
                              {{ subItem.controls.subTotal.value | currency:'':'' }}
                            </div>
                          <td>
                            <div class="values" style="width: 90px;">
                              {{ subItem.controls.retention.value | currency:'':'' }}
                            </div>

                          </td>

                        </ng-container>
                        <td>
                          <input type="number" style="width:66px;" formControlName="percentage_sale"
                            class="form-control form-control-sm" />
                        </td>
                        <td>
                          <div class="values" style="width: 110px;">
                            {{ subItem.controls.value_cop.value | currency:'':'' }}
                          </div>
                        </td>
                        <td>
                          <div class="values" style="width: 110px;">
                            {{ subItem.controls.value_usd.value | currency:'':'' }}
                          </div>

                        </td>
                        <!-- END Variables TOTAl Venta -->

                        <td>
                          <input type="text" style="width: 90px;" class="form-control form-control-sm" />
                        </td>
                        <td class="text-center"><i ngbTooltip="Eliminar Sub Item" (click)="deleteSubItem(item,y)"
                            class="text-danger far fa-trash-alt"></i></td>
                      </tr>
                    </ng-container>
                    <tr class="bg-gray">
                      <td colspan="6">SUBTOTAL ITEM {{i + 1}}</td>
                      <td>$0</td>
                      <td>$ </td>
                      <td>$ </td>
                      <td>$ </td>
                      <td>$ </td>
                      <td>$ </td>
                      <td>$ </td>
                      <td> </td>
                      <td></td>
                    </tr>
                  </ng-container>



                </tbody>
              </table>
              <div class="text-right">
                <button ngbTooltip="Agregar Sub Item" (click)="addSubItem(item)" class="btn btn-info btn-sm">
                  <i class="fas fa-plus"></i>
                </button>
              </div>

            </div>
          </div>
        </div>
      </ng-container>

      <div class="col-12 mb-4 text-right">
        <button (click)="addItems()" class="btn btn-success btn-sm" ngbTooltip="Agregar Item">
          <i class="fas fa-plus"></i>
        </button>
      </div>

      <div *ngIf="items.controls.length" class="col-12 card card-body">
        <table>

          <tbody>
            <tr>
              <td colspan="10"> TOTAL PRESUPUESTO </td>
              <td colspan="1">COP $</td>
              <td colspan="1">USD $</td>

            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <!-- END ITEMS -->

  </form>

</div>


<ng-template #notData>
  <div class="card col-12">
    <div class="card-body">
      <div class=" p-2  text-center">
        <h5 class="text-dark">Sin datos agregados</h5>
      </div>
    </div>
  </div>
</ng-template>

<ng-template #notData2>
  <tr class="bg-light">
    <td colspan="100%" class="text-center">
      <p class="text-dark p-1">Sin datos agregados</p>
    </td>
  </tr>
</ng-template>


<ng-template #down>
  <i class="fas fa-chevron-down text-primary"></i>
</ng-template>