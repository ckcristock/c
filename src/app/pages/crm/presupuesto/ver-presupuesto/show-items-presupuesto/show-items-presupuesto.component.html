<ng-container *ngIf="items.length">


    <div class="row ">
        <div class="col-12 text-center m-4">
            <h4>Elementos del presupuesto</h4>
        </div>


        <div class="card " style="width:100% ;" *ngFor="let item of items; let i = index">
            <div class="card-header header-item w-100">
                <div class=" d-flex align-items-center justify-content-between">
                    <span class="bg-info p-2 text-white">{{ i + 1 }}</span>
                    <span class="text-center"> <strong>ITEM {{ i + 1 }} </strong></span>
                </div>
            </div>
            <div style="overflow-x:auto;" class="items table-responsive" class="card-body ">

                <table width="100%" cellspacing="0" class="table table-striped table-sm table-items">
                    <thead>

                        <tr>
                            <th colspan="6">Costos Directos</th>
                            <th [DynamicColspan]="'indirect_cost'" min="1" [max]="(data.indirect_costs.length + 1)"
                                class="detachable" (click)="item.shows.indirect_cost = !item.shows.indirect_cost ">
                                <ng-container *ngIf="item.shows.indirect_cost ; else down">
                                    <i class=" fas fa-chevron-right text-primary"></i>
                                </ng-container>
                                Cost. Indirectos
                            </th>
                            <th DynamicColspan min="1" [max]="(7)" class="detachable"
                                (click)=" item.shows.sum_others = !item.shows.sum_others">
                                <ng-container *ngIf="item.shows.sum_others ; else down">
                                    <i class=" fas fa-chevron-right text-primary"></i>
                                </ng-container>
                                ADM + IMP + UTI
                            </th>
                            <th DynamicColspan min="4" (click)="item.shows.total_sale = !item.shows.total_sale"
                                [max]="6" class="detachable">
                                <ng-container *ngIf="item.shows.total_sale ; else down">
                                    <i class=" fas fa-chevron-right text-primary"></i>
                                </ng-container>
                                Valor Venta
                            </th>
                            <th (click)=" item.shows.prorrateo = !item.shows.prorrateo" class="detachable"
                                *ngIf="item.shows.prorrateo" colspan="4">
                                <ng-container *ngIf="item.shows.prorrateo ; else down">
                                    <i class=" fas fa-chevron-right text-primary"></i>
                                </ng-container>
                                Prorrateo de Valores
                            </th>
                            <th></th>

                            <th></th>
                        </tr>
                        <tr>
                            <th>#</th>
                            <th>Tipo</th>
                            <th>Descripción</th>

                            <th>Cantidad</th>
                            <th>C. Unitario</th>
                            <th title="Valor Total Costo">VT. Costo</th>
                            <ng-container *ngIf="item.shows.indirect_cost">
                                <th *ngFor="let indirect of data.indirect_costs">
                                    {{indirect.indirect_cost.name}}
                                </th>

                            </ng-container>

                            <th title="Subtotal Indirectos">SubT. Indirectos</th>

                            <ng-container *ngIf="item.shows.sum_others">
                                <th>%</th>
                                <th>AMD</th>
                                <th>%</th>
                                <th>Imprevistos</th>
                                <th>%</th>
                                <th>Utilidad</th>
                            </ng-container>

                            <th>ADM+IMP+UTI</th>
                            <th>Otros Cargos</th>
                            <ng-container *ngIf="item.shows.total_sale">
                                <th>Subtotal</th>
                                <th>Retención</th>
                            </ng-container>
                            <th>%</th>
                            <th>V/U Venta COP</th>
                            <th>V/U Venta USD</th>
                            <ng-container *ngIf="item.shows.prorrateo">
                                <th>V. Prorr. COP</th>
                                <th>V. Prorr. USD</th>
                                <th>V/U Venta Prorr. COP</th>
                                <th>V/U Venta Prorr. USD</th>
                            </ng-container>

                            <th>Observ.</th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody>

                        <ng-container *ngFor="let subItem of item.subitems; let y = index;">
                            <tr>
                                <td> {{i + 1 }}.{{y+1}}</td>
                                <td>
                                    {{subItem.type}}
                                </td>
                                <td>
                                    <div style="position: relative;">
                                        <span *ngIf="subItem.apu_set">{{subItem.apu_set.name}}</span>
                                        <span *ngIf="subItem.apu_part">{{subItem.apu_part.name}}</span>
                                        <span *ngIf="subItem.apu_service">{{subItem.apu_service.name}}</span>
                                        <span *ngIf="!subItem.type_module">{{subItem.description}}</span>

                                    </div>
                                </td>

                                <td class="text-right">
                                    {{subItem.cuantity | currency:'':''}}
                                </td>
                                <td class="text-right">
                                    {{subItem.unit_cost | currency:'':''}}

                                </td>
                                <td class="text-right">
                                    {{subItem.total_cost | currency:'':''}}
                                </td>

                                <ng-container *ngIf="item.shows.indirect_cost">
                                    <ng-container
                                        *ngFor="let indirect of  subItem.indirect_costs; let indirecIndex = index">
                                        <td class="text-right" style="width:90px">
                                            {{ indirect.value | currency:'':''}}
                                        </td>
                                    </ng-container>

                                </ng-container>
                                <td class="text-right" style="width:90px">
                                    {{subItem.subtotal_indirect_cost |
                                    currency:'':'' }}
                                </td>
                                <ng-container *ngIf="item.shows.sum_others">

                                    <td class="text-right" style="width:70px">
                                        {{subItem.percentage_amd}}
                                    </td>
                                    <td class="text-right" style="width:90px">
                                        {{ subItem.value_amd | currency:'':'' }}
                                    </td>
                                    <td class="text-right" class="text-right" style="width:70px">
                                        {{subItem.percentage_unforeseen}}
                                    </td>
                                    <td class="text-right" style="width:90px">
                                        {{ subItem.value_unforeseen | currency:'':'' }}
                                    </td>
                                    <td class="text-right" style="width:70px">{{subItem.percentage_utility}}
                                    </td>
                                    <td class="text-right" style="width:90px">
                                        {{ subItem.value_utility | currency:'':'' }}
                                    </td>

                                </ng-container>

                                <td class="text-right" style="width:90px">
                                    {{ subItem.total_amd_imp_uti | currency:'':'' }}
                                </td>


                                <td class="text-right">
                                    {{subItem.another_values | currency:'':''}}
                                </td>
                                <ng-container *ngIf="item.shows.total_sale">

                                    <td class="text-right" style="width: 90px;">
                                        {{ subItem.subTotal | currency:'':'' }}
                                    <td class="text-right" style="width: 90px;">
                                        {{ subItem.retention | currency:'':'' }}

                                    </td>

                                </ng-container>
                                <td class="text-center" style="width: 50px;">
                                    % {{ subItem.percentage_sale }}
                                </td>
                                <td class="text-right" style="width: 110px;">
                                    {{ subItem.value_cop | currency:'':'' }}
                                </td>
                                <td class="text-right" style="width: 110px;">
                                    {{ subItem.value_usd | currency:'':'' }}

                                </td>
                                <ng-container *ngIf="item.shows.prorrateo">
                                    <td class="text-right" style="width:90px">
                                        {{ subItem.value_prorrota_cop | currency:'':'' }}
                                    </td>
                                    <td class="text-right" style="width:90px">
                                        {{ subItem.value_prorrota_usd | currency:'':'' }}
                                    </td>
                                    <td class="text-right" style="width:90px">
                                        {{ subItem.unit_value_prorrateado_cop |
                                        currency:'':'' }}
                                    </td>
                                    <td class="text-right" style="width:90px">
                                        {{ subItem.unit_value_prorrateado_usd |
                                        currency:'':'' }}
                                    </td>
                                </ng-container>
                                <td style="width: 100px;">
                                    {{subItem.observation}}
                                </td>
                                <td class="text-center" style="width: 20px;">
                                    <i ngbTooltip="Prorrateo de valores"
                                        (click)="item.shows.prorrateo = !item.shows.prorrateo "
                                        class="text-primary  fas fa-hand-holding-usd mr-2"></i>
                                </td>
                            </tr>
                        </ng-container>

                        <tr class="bg-gray">
                            <td colspan="5">SUBTOTAL ITEM {{i + 1}}</td>
                            <td class="text-right">
                                {{ item.total_cost | currency:'':''}}
                            </td>
                            <ng-container *ngIf="item.shows.indirect_cost">

                                <ng-container
                                    *ngFor="let subtIndirect of  item.subtotal_indirect_cost_dynamic ; let indirecTotalIndex = index">
                                    <td class="text-right">
                                        {{ subtIndirect.controls.sub_total.value | currency:'':''}}
                                    </td>
                                </ng-container>

                            </ng-container>
                            <td class="text-right">

                                {{ item.subtotal_indirect_cost | currency:'':''}}
                            </td>

                            <ng-container *ngIf="item.shows.sum_others">
                                <td></td>
                                <td class="text-right">
                                    {{ item.value_amd | currency:'':''}}
                                </td>
                                <td></td>
                                <td class="text-right">

                                    {{ item.value_unforeseen | currency:'':''}}
                                </td>
                                <td></td>
                                <td class="text-right">
                                    {{ item.value_utility | currency:'':''}}
                                </td>


                            </ng-container>
                            <td class="text-right">
                                {{ item.total_amd_imp_uti | currency:'':''}}
                            </td>
                            <td class="text-right">
                                {{ item.another_values | currency:'':''}}
                            </td>

                            <ng-container *ngIf="item.shows.total_sale">
                                <td class="text-right">
                                    {{ item.subTotal | currency:'':''}}
                                </td>
                                <td class="text-right">
                                    {{ item.retention | currency:'':''}}
                                </td>
                            </ng-container>
                            <td class="text-center">
                                % {{ item.percentage_sale }}
                            </td>
                            <td class="text-right">

                                {{ item.value_cop | currency:'':''}}
                            </td>
                            <td class="text-right">

                                {{ item.value_usd | currency:'':''}}
                            </td>

                            <ng-container *ngIf="item.shows.prorrateo">
                                <td style="width:80px" class="text-right">
                                    {{item.value_prorrota_cop | currency:'':''}}
                                </td>
                                <td style="width:80px" class="text-right">
                                    {{item.value_prorrota_usd | currency:'':''}}
                                </td>
                                <td class="text-right">

                                    {{ item.unit_value_prorrateado_cop | currency:'':''}}
                                </td>
                                <td class="text-right">

                                    {{ item.unit_value_prorrateado_usd | currency:'':''}}
                                </td>
                            </ng-container>
                            <td colspan="2"></td>

                        </tr>


                    </tbody>

                </table>


            </div>

        </div>


    </div>

    <ng-template #notData>
        <div class="card col-12">
            <div class="card-body">
                <div class=" p-2  text-center">
                    <h5 class="text-dark">Sin datos agregados</h5>
                </div>
            </div>
        </div>
    </ng-template>

</ng-container>


<ng-template #down>
    <i class="fas fa-chevron-down text-primary"></i>
</ng-template>