<ng-template #placeholder>
  <app-placeholder-form></app-placeholder-form>
</ng-template>

<ng-container *ngIf="!loading; else placeholder">
  <div class="row">
    <div class="col">
      <div class="card">
        <div class="card-body">
          <app-cabecera [datosCabecera]="datosCabecera"></app-cabecera>
          <hr class="line" />
          <ng-container [formGroup]="form">
            <!-- SECCION DE FACTURAS -->
            <ng-container formArrayName="invoices">
              <div class="row card-title d-flex justify-content-between">
                <div class="col-md-6 px-0">
                  <h6 class="text-primary">Facturas</h6>
                </div>
                <div class="col-md-6 px-0 text-right">
                  <div class="btn-group rounded w-sm-100">
                    <button
                      class="btn btn-primary btn-sm"
                      type="button"
                      (click)="addInvoice()"
                    >
                      <!-- //este boton debe tener un ngIf de permisos  -->
                      <i class="fa fa-plus"></i> Agregar
                    </button>
                  </div>
                </div>
              </div>

              <ng-container
                *ngIf="invoices.controls.length > 0; else notDataInfo"
              >
                <div class="rounded-top table-responsive">
                  <table class="table table-bordered table-striped table-sm">
                    <thead class="bg-light">
                      <tr class="text-center text-uppercase">
                        <th>#</th>
                        <th>Número factura</th>
                        <th>Fecha</th>
                        <th>Archivo</th>
                        <th>Retenciones</th>
                        <th><i class="mdi mdi-chevron-down"></i></th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr
                        [formGroupName]="i"
                        *ngFor="let invoice of invoices.controls; let i = index"
                        class="text-center"
                      >
                        <td class="p-0">{{ i + 1 }}</td>
                        <td class="p-0">
                          <!-- <mat-form-field class="col" appearance="outline"> -->
                            <input
                              type="text"
                              placeholder="Ingresa el número de factura*"
                              formControlName="Factura"
                              required
                              autocomplete="off"
                              class="w-100 border-0"
                              style="border: 0"
                            />
                          <!-- </mat-form-field> -->
                        </td>
                        <td class="p-0">
                          <!-- <mat-form-field class="col" appearance="outline"> -->
                            <input
                              [matDatepicker]="picker"
                              placeholder="Elije la fecha*"
                              formControlName="Fecha_Factura"
                              readonly
                              autocomplete="off"
                              class="border-0"
                              style="border: 0"
                            />
                            <mat-datepicker-toggle
                              matSuffix
                              [for]="picker"
                            ></mat-datepicker-toggle>
                            <mat-datepicker #picker></mat-datepicker>

                          <!-- </mat-form-field> -->
                        </td>

                        <td class="p-0 d-flex align-items-center justify-content-center">
                          <div class="form-group text-center col">
                            <div class="custom-input-file">
                              <input
                                type="file"
                                #fileInput
                                id="importFile"
                                accept=".pdf"
                                class="input-file"
                                (change)="onFileChanged($event, i)"
                              />
                              Cargar factura
                            </div>
                            <div class="text-center">
                              <small
                                *ngIf="invoice.get('Archivo_Factura').value"
                                class="text-success"
                                >Cotización cargada exitosamente</small
                              >
                            </div>
                          </div>
                        </td>
                        <td class="p-0">
                          <!-- <input
                            type="text"
                            placeholder="Retenciones"
                            formControlName="retencion"
                            required
                            autocomplete="off"
                          /> -->
                        </td>
                        <td>
                          <button
                            type="button"
                            (click)="removeInvoice(i)"
                            class="btn btn-danger btn-sm"
                          >
                            <i class="fas fa-trash-alt"></i>
                          </button>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </ng-container>

              <!-- Tabla para facturas -> muchos items que se recorren, vas a tener un boton de agregar general y un boton de eliminar para cada factura, vas a tener el input para el nombre, otro para la fecha, este preferiblemente con datepicker de angular, otro para cargar archivo, tal como lo venimos llevando en todo el software, y que tenga restriccion de tipo de archivo, solo pdf o imgen (png, jpg, jpge), y que muestre cuando el archivo esté cargado, adicional habrá un campo para retenciones pero no tiene importancia

              -->
            </ng-container>
            <!-- SECCION DE productos -->
            <ng-container formArrayName="products">
              <div class="row card-title d-flex justify-content-between">
                <div class="col-md-12 px-0">
                  <h6 class="text-primary">Productos</h6>
                </div>

                <div class="rounded-top table-responsive mt-2">
                  <table class="table table-bordered table-striped table-sm">
                    <thead class="bg-light">
                      <tr class="text-center text-uppercase">
                        <th></th>
                        <th>Imagen</th>
                        <th>Producto</th>
                        <th>Cantidad</th>
                        <th>Unidad</th>
                        <th>Subtotal</th>
                        <th>Iva</th>
                        <th>Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr
                        *ngFor="let product of products.controls; let i = index"
                        [formGroupName]="i"
                        class="text-center"
                      >
                        <td>
                          <mat-checkbox></mat-checkbox>
                        </td>
                        <td class="align-middle">
                          {{ product.get("imagen").value }}
                        </td>
                        <td class="align-middle">
                          {{ product.get("nombre").value | uppercase }}
                        </td>
                        <td>

                          <input
                          type="text"
                          formControlName="Cantidad"
                          currencyMask
                          [options]="mask.maskNumbers"
                          appInputPositionInitial
                          class="w-100 border-0"
                          style="border: 0"

                        />

                        </td>
                        <td>{{ product.get("unidad").value | titlecase}}</td>
                        <td>
                            <input

                              placeholder="Ingresa un valor"
                              currencyMask
                              appInputPosition
                              [options]="mask.maskCOP"
                              formControlName="Subtotal"
                              autocomplete="off"
                              class="w-100 border-0"
                              style="border: 0"
                            />
                        </td>
                        <td>
                            <input
                              placeholder="Ingresa un valor"
                              currencyMask
                              appInputPosition
                              [options]="mask.maskCOP"
                              formControlName="Impuesto"
                              autocomplete="off"
                              class="w-100 border-0"
                              style="border: 0"
                            />
                        </td>
                        <td>
                            <input
                              placeholder="Ingresa un valor"
                              currencyMask
                              appInputPosition
                              [options]="mask.maskCOP"
                              formControlName="Precio"
                              autocomplete="off"
                              class="w-100 border-0"
                              style="border: 0"
                            />
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
              <!-- tabla para productos -> inicialmente se van a listar los productos de la orden de compra, con imagen, y con campos para la cantidad, el iva y los precios (precio total, precio iva, subtotal sin iva), habrá un checkbox para seleccionar los productos que se ingresan, y habrá una comparativa con la informacion que viene de la orden de compra, muestras un icon de un alert o de un ! con un tooltip donde describa que el campo es diferente a la orden de compra  -->
            </ng-container>
            <mat-form-field
            class="col-md-12 mat-form-field-no-padding textarea"
            appearance="outline"
          >
            <mat-label>Observaciones</mat-label>
            <textarea
              matInput
              placeholder="Ingresa las observaciones"
              rows="5"
              formControlName="Observaciones"
              [cdkTextareaAutosize]="true"
            ></textarea>

          </mat-form-field>
            <button
            class="btn btn-block btn-primary"
            type="submit"
            form="form"
            (click)="save()"
            [disabled]="!form.valid"
          >

            Guardar
          </button>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</ng-container>

<ng-template #notData>
  <app-not-data [loading]="loading"></app-not-data>
</ng-template>
<ng-template #notDataInfo>
  <div class="alert alert-warning" role="alert">No hay nada aquí</div>
</ng-template>
