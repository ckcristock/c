<div class="row mb-4">
    <div class="col text-left">
        <a class="text-primary back" [routerLink]="['/rrhh/procesos/disciplinarios']">Regresar</a>
    </div>
</div>
<div class="card">
    <div class="card-header">
        <div class="card-title">
            <div class="row">
                <div class="col-6">
                    <h5 class="text-primary"> Seguimiento Proceso Disciplinario </h5>
                </div>
                <div class="col-6 text-right" *ngIf="!loading && processSelected">
                    <div *ngIf="permission.permissions.close && processSelected.status!='Cerrado'">
                        <button class="btn btn-danger btn-sm col-2" style="float: right;" (click)="closeProccess()"> Cerrar </button>
                    </div>
                    <div *ngIf="processSelected.status == 'Cerrado' && permission.permissions.open">
                        <button class="btn btn-success btn-sm col-2" style="float: right;" (click)="openProccess()"> Abrir </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="card-body" *ngIf="!loading; else notData">
        <div class=" row ml-0 mr-0">
            <div class="form-group col-md-2">
                <label style="color: black;">Funcionario Resp.</label>
                <p>{{fullNameSelected}}</p>
            </div>
            <!-- <div class="row  ml-0 mr-0"> -->
            <div class="form-group col-md-2">
                <label style="color: black;">Fecha Inicio</label>
                <p>{{processSelected.date_of_admission}}</p>
            </div>
            <div class="form-group col-md-2" *ngIf="processSelected.status == 'Cerrado'">
                <label style="color: black;">Fecha Final</label>
                <p>{{processSelected.date_end}}</p>
            </div>
            <!-- </div> -->
            <div class=" form-group col-3">
                <label style="color: black;">Descripción</label>
                <p>{{processSelected.process_description}}</p>
            </div>
            <div class="col-md-3 text-right ">
                <button class="btn btn-primary btn-sm" *ngIf="file" (click)="download(file, fileType)">
                            <i class="far fa-arrow-alt-circle-down"> Descargar Evidencia</i>
                        </button>
            </div>
            <div class=" form-group col-12" *ngIf="processSelected.status == 'Cerrado'">
                <label style="color: black;">Observación del cierre</label>
                <p>{{processSelected.close_description}}</p>
            </div>
            <div class="col-12">
                <hr class="line">
            </div>
            <div class="col-12">
                <div class="row">
                    <div class="col-6">
                        <label for="">Anotaciones</label>
                    </div>
                    <div class="col-6 text-right" *ngIf="processSelected.status != 'Cerrado'">
                        <button class="btn btn-info btn-sm" (click)="openModal()"> Agregar </button>
                    </div>
                </div>
                <div class="col panel-anotaciones mt-3">
                    <div class="card card-anotation" *ngFor="let anotacion of anotaciones; let i = index">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-2">
                                    <label for="">Func. Creó</label>
                                    <h6 class="mb-2 text-muted">{{anotacion.user.person.first_name + ' ' + anotacion.user.person.first_surname }}</h6>
                                </div>
                                <div class="col-2">
                                    <label for="">Involucrado</label>
                                    <h6 class="mb-2 text-muted">{{ anotacion.person.first_name }} {{ anotacion.person.first_surname }}</h6>
                                </div>
                                <div class="col-1">
                                    <label for="">Memorandos</label>
                                    <h6 class="mb-2 text-muted">
                                        <div>
                                            <button class="btn btn-primary btn-sm waves-effect waves-light" type="button" (click)="collapsed[i] = !collapsed[i]" [attr.aria-expanded]="!collapsed" aria-controls="collapseExample2">
                                                <i class="mdi mdi-chevron-down" *ngIf="!collapsed[i]"></i>
                                                <i class="mdi mdi-chevron-up" *ngIf="collapsed[i]"></i>
                                            </button>
                                        </div>
                                    </h6>
                                </div>
                                <div class="col-2">
                                    <label for="">Observaciones</label>
                                    <p class="card-text"> {{ anotacion.observation }}</p>
                                </div>
                                <div class="col-2">
                                    <label for="">Fecha Creación</label>
                                    <h6 class="mb-2 text-muted">{{ anotacion.created_at | date }}</h6>
                                </div>
                                <div class="col-2">
                                    <a *ngIf="anotacion.file" (click)="download(anotacion.file, anotacion.fileType)" class="col-3 card-link pointer">Descargar evidencia</a>
                                </div>
                                <div class="col-1" *ngIf="processSelected.status != 'Cerrado'">
                                    <label for="">Anular</label>
                                    <h6 class="mb-2 text-muted">
                                        <div>
                                            <button class="btn btn-outline-danger btn-sm waves-effect waves-light" type="button" (click)="cancelAnnotation(anotacion.id)">
                                                <i class="fas fa-trash-alt"></i>
                                            </button>
                                        </div>
                                    </h6>
                                </div>
                                <div class="col-12" [ngbCollapse]="!collapsed[i]">
                                    <table class="table table-sm table-borderless">
                                        <ng-container *ngIf="anotacion.memorandum_involved.length > 0; else notM">
                                            <thead class="bg-light">
                                                <tr>
                                                    <th>Motivo</th>
                                                    <th>Detalle</th>
                                                    <th>Fecha C.</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr *ngFor="let item of anotacion.memorandum_involved">
                                                    <td> {{ item.memorandum.memorandumtype.name }} </td>
                                                    <td> {{ item.memorandum.details }} </td>
                                                    <td> {{ item.memorandum.created_at | date }} </td>
                                                </tr>
                                            </tbody>
                                        </ng-container>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col">
                    <label class="ml-0" *ngIf="legalDocuments.length > 0">Documentos</label>
                </div>
                <div class="row">
                    <ng-container *ngFor="let item of legalDocuments">
                        <div class="col-2">
                            <div class="card card-file">
                                <div class="card-title">
                                    <button type="button" *ngIf="processSelected.status != 'Cerrado'" placement="top" ngbTooltip="Eliminar" class="close basic-close mt-2 mr-3" (click)="deleteDocument(item)">
                                        <span aria-hidden="true">
                                            <i class="fas fa-times"></i>
                                        </span>
                                    </button>
                                </div>
                                <div class="card-body" (click)="downloadDocument(item)" placement="left" ngbTooltip="Descargar">
                                    <h6 class="file-title text-center">
                                        {{ item.name }}
                                    </h6>
                                </div>
                            </div>
                        </div>
                    </ng-container>
                </div>
            </div>
            <div class="col-12 mt-3" *ngIf="processSelected">
                <div class="row">
                    <ng-container *ngIf="processSelected.status != 'Cerrado'">
                        <button class="btn btn-success btn-sm btn-block" style="float: right;" (click)="modalDocuments.show()"> Agregar Documentos </button>
                    </ng-container>
                </div>
            </div>
        </div>
    </div>
</div>
<app-modal-basic #modal [dialogClass]="'modal-lg'">
    <div class="app-modal-header">
        <h5 class="modal-title"> Agregar involucrados </h5>
        <button type="button" class="close basic-close" (click)="closeModal()">
            <span aria-hidden="true">
                <i class="fas fa-times" (click)="closeModal()"></i>
            </span>
        </button>
    </div>
    <div class="app-modal-body">
        <form [formGroup]="formSeguimiento">
            <div class="form-row">
                <div class="col-6">
                    <div class="form-group">
                        <div class="col-12">
                            <label class="custom-label" for="funcionario_id">Funcionario</label>
                            <input id="typeahead" type="text" class="form-control form-control-sm" placeholder="Funcionario..." formControlName="person" (change)="getHistory()" [ngbTypeahead]="search" [inputFormatter]="inputFormatBandListValue" [resultFormatter]="resultFormatBandListValue"
                                [editable]='false' />
                            <ng-container *ngIf="person_id_valid">
                                <small *ngFor="let item of formSeguimiento.get('person').errors | ObjToArrayPipe" class="text-danger">
                                    {{ item?.msj }}
                                </small>
                            </ng-container>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-12">
                            <label for="">Observaciones</label>
                            <textarea class="form-control form-control-sm" name="ob" id="obervaciones" rows="3" formControlName="observation"></textarea>
                        </div>
                    </div>
                    <div class="form-group">
                        <div class="col-12">
                            <label for="importFile">Evidencia</label>
                            <input #inputFile type="file" id="importFileP" (change)="onFileChanged($event)" accept=".pdf, .png, .jpg, .jpeg">
                        </div>
                    </div>
                </div>
                <div class="col-md-6 panel">
                    <div class="panel-body">
                        <div class="ml-4">
                            <div class="mt-5 text-center" *ngIf="!formSeguimiento.get('person').value">
                                <i class="fa fa-exclamation-circle fa-3x"></i>
                                <h4>Seleccione un funcionario</h4>
                            </div>
                            <div class="mt-5 text-center" *ngIf="historyInfo.length < 0">
                                <i class="fas fa-cloud"></i>
                                <h4>Sin Memorandos</h4>
                            </div>
                            <div class="mt-4">
                                <div *ngFor="let historyInf of historyInfo; let i = index">
                                    <input class="mr-2" type="checkbox" [value]="historyInf.details" [id]="historyInf.id" [date]="historyInf.created_at_memorandum" (change)="onSelectOption($event, i)" [name]="historyInf.memorandumType">
                                    <label for="checkbox" class="ml-3">
                                        <b lass="fs-3"> Memorando | <i styles="color:gray;"> {{
                                                historyInf.created_at_memorandum | date:'MM-dd-yy' }} </i>
                                        </b><br>
                                        <strong>Categoria:</strong> <b> {{ historyInf.activity !="" ?
                                            historyInf.memorandumType : 'Sin Categoria' }} </b>
                                            <br>
                                        <label>Detalle: {{ historyInf.details }} </label>
                                    </label>
                                    <hr>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="app-modal-footer">
        <div class="form-group text-right">
            <button (click)="closeModal()" type="button" class="btn btn-danger raised mr-2 btn-sm" (click)="closeModal()">Cerrar</button>
            <button type="submit" class="btn btn-primary btn-sm raised" (click)="agregarAnotacion(); inputFile.value=''">Guardar</button>
        </div>
    </div>
</app-modal-basic>

<app-modal-basic #modalClose [dialogClass]="'modal-sm'">
    <div class="app-modal-header">
        <h5 class="modal-title"> Cerrar proceso </h5>
        <button type="button" class="close basic-close" (click)="modalClose.hide()">
            <span aria-hidden="true">
                <i class="fas fa-times" (click)="modalClose.hide()"></i>
            </span>
        </button>
    </div>
    <div class="app-modal-body">
        <form [formGroup]="formSeguimiento">
            <div class="form-row">
                <div class="col-12">
                    <div class="form-group">
                        <label for="">Descripción</label>
                        <textarea class="form-control form-control-sm" rows="3"></textarea>
                    </div>
                </div>
            </div>
        </form>
    </div>
    <div class="app-modal-footer">
        <div class="form-group text-right">
            <button (click)="modalClose.hide()" type="button" class="btn btn-danger raised mr-2 btn-sm">Cancelar</button>
            <button type="submit" class="btn btn-primary btn-sm raised">Cerrar</button>
        </div>
    </div>
</app-modal-basic>
<app-modal-basic #modalDocuments [dialogClass]="'modal-lg'">
    <div class="app-modal-header">
        <h5 class="modal-title"> Agregar Documentos </h5>
        <button type="button" class="close basic-close" (click)="hideModalDocuments()">
            <span aria-hidden="true">
                <i class="fas fa-times" (click)="hideModalDocuments()"></i>
            </span>
        </button>
    </div>
    <div class="app-modal-body">
        <div class="col-12">
            <label for="">Documentos</label>
            <div class="col">
                <ngx-dropzone class="drop-zone" (change)="onSelect($event)">
                    <ngx-dropzone-label>
                        <span><i class="fas fa-cloud-download-alt"></i></span> Arrastre y suelte el archivo
                    </ngx-dropzone-label>
                    <ngx-dropzone-preview *ngFor="let f of files" [removable]="true" (removed)="onRemove(f)">
                        <ngx-dropzone-label>{{ f.name }} ({{ f.type }})</ngx-dropzone-label>
                    </ngx-dropzone-preview>
                </ngx-dropzone>
            </div>
        </div>
    </div>
    <div class="app-modal-footer">
        <div class="form-group text-right">
            <button (click)="hideModalDocuments()" type="button" class="btn btn-danger raised mr-2 btn-sm">Cerrar</button>
            <button type="submit" class="btn btn-primary btn-sm raised" (click)="saveDocuments()">Guardar Documentos</button>
        </div>
    </div>
</app-modal-basic>
<ng-template #notM>
    <tr class="bg-light">
        <td colspan="3" class="text-center">
            <p class="text-dark">Sin memorandos agregados</p>
        </td>
    </tr>
</ng-template>
<ng-template #notData>
    <app-not-data [loading]="loading"></app-not-data>
</ng-template>